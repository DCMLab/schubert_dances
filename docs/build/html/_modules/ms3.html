

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ms3 &mdash; Schubert Dances 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Schubert Dances
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../libs.html">libs package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Schubert Dances</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>ms3</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ms3</h1><div class="highlight"><pre>
<span></span><span class="c1"># %% Run this cell with ALT + SHIFT + ENTER (e.g. with Hydrogen package within Atom)</span>
<span class="sd">&quot;&quot;&quot;MuseScore3 Parser by Johannes Hentschel</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">###################</span>
<span class="c1">#Internal libraries</span>
<span class="c1">###################</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">argparse</span><span class="o">,</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">fractions</span> <span class="k">import</span> <span class="n">Fraction</span> <span class="k">as</span> <span class="n">frac</span>


<span class="c1">###################</span>
<span class="c1">#External libraries</span>
<span class="c1">###################</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="k">import</span> <span class="n">BeautifulSoup</span> <span class="k">as</span> <span class="n">bs</span>         <span class="c1"># python -m pip install beautifulsoup4, lxml</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1">###########</span>
<span class="c1"># Constants</span>
<span class="c1">###########</span>
<span class="n">DURATIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;measure&quot;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
             <span class="s2">&quot;breve&quot;</span>   <span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
             <span class="s2">&quot;whole&quot;</span>   <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
             <span class="s2">&quot;half&quot;</span>    <span class="p">:</span> <span class="n">frac</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
             <span class="s2">&quot;quarter&quot;</span> <span class="p">:</span> <span class="n">frac</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">),</span>
             <span class="s2">&quot;eighth&quot;</span>  <span class="p">:</span> <span class="n">frac</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span>
             <span class="s2">&quot;16th&quot;</span>    <span class="p">:</span> <span class="n">frac</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">16</span><span class="p">),</span>
             <span class="s2">&quot;32nd&quot;</span>    <span class="p">:</span> <span class="n">frac</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">32</span><span class="p">),</span>
             <span class="s2">&quot;64th&quot;</span>    <span class="p">:</span> <span class="n">frac</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">64</span><span class="p">),</span>
             <span class="s2">&quot;128th&quot;</span>   <span class="p">:</span> <span class="n">frac</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">128</span><span class="p">)}</span>

<span class="n">NEWEST_MUSESCORE</span> <span class="o">=</span> <span class="s1">&#39;3.3.4&#39;</span>

<span class="n">NL</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

<span class="n">PITCH_NAMES</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span>
               <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span>
               <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span>
               <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span>
               <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
               <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span>
               <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">}</span>

<span class="n">PITCH_DEGREES</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span>
               <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
               <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span>
               <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span>
               <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span>
               <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span>
               <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;VII&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="SliceMaker"><a class="viewcode-back" href="../ms3.html#ms3.SliceMaker">[docs]</a><span class="k">class</span> <span class="nc">SliceMaker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This class serves for passing slice notation such as :3 as function arguments.</span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">        SL = SliceMaker()</span>
<span class="sd">        some_function( slice_this, SL[3:8] )&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span></div>

<span class="n">SL</span><span class="p">,</span> <span class="n">SM</span> <span class="o">=</span> <span class="n">SliceMaker</span><span class="p">(),</span> <span class="n">SliceMaker</span><span class="p">()</span>

<span class="n">TIMESIG_BEAT</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;3/16&#39;</span><span class="p">:</span> <span class="s1">&#39;1/16&#39;</span><span class="p">,</span>
                <span class="s1">&#39;6/16&#39;</span><span class="p">:</span> <span class="s1">&#39;3/16&#39;</span><span class="p">,</span>
                <span class="s1">&#39;3/8&#39;</span><span class="p">:</span>  <span class="s1">&#39;1/8&#39;</span><span class="p">,</span>
                <span class="s1">&#39;4/8&#39;</span><span class="p">:</span>  <span class="s1">&#39;1/4&#39;</span><span class="p">,</span>
                <span class="s1">&#39;6/8&#39;</span><span class="p">:</span>  <span class="s1">&#39;3/8&#39;</span><span class="p">,</span>
                <span class="s1">&#39;9/8&#39;</span><span class="p">:</span>  <span class="s1">&#39;3/8&#39;</span><span class="p">,</span>
                <span class="s1">&#39;12/8&#39;</span><span class="p">:</span> <span class="s1">&#39;3/8&#39;</span><span class="p">,</span>
                <span class="s1">&#39;2/4&#39;</span><span class="p">:</span>  <span class="s1">&#39;1/4&#39;</span><span class="p">,</span>
                <span class="s1">&#39;3/4&#39;</span><span class="p">:</span>  <span class="s1">&#39;1/4&#39;</span><span class="p">,</span>
                <span class="s1">&#39;4/4&#39;</span><span class="p">:</span>  <span class="s1">&#39;1/4&#39;</span><span class="p">,</span>
                <span class="s1">&#39;6/4&#39;</span><span class="p">:</span>  <span class="s1">&#39;3/4&#39;</span><span class="p">,</span>
                <span class="s1">&#39;2/2&#39;</span><span class="p">:</span>  <span class="s1">&#39;1/2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;3/2&#39;</span><span class="p">:</span>  <span class="s1">&#39;1/2&#39;</span><span class="p">,</span>
                <span class="p">}</span>

<span class="c1"># XML tags of MuseScore 3 format that this parser takes care of</span>
<span class="n">TREATED_TAGS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;acciaccatura&#39;</span><span class="p">,</span>
                <span class="s1">&#39;accidental&#39;</span><span class="p">,</span>   <span class="c1"># within &lt;KeySig&gt;</span>
                <span class="s1">&#39;Accidental&#39;</span><span class="p">,</span>   <span class="c1"># within &lt;Note&gt;, ignored</span>
                <span class="s1">&#39;actualNotes&#39;</span><span class="p">,</span>  <span class="c1"># within &lt;Tuplet&gt;</span>
                <span class="s1">&#39;anchor&#39;</span><span class="p">,</span>       <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;appoggiatura&#39;</span><span class="p">,</span> <span class="c1"># stored in note list</span>
                <span class="s1">&#39;Articulation&#39;</span><span class="p">,</span> <span class="c1"># optional</span>
                <span class="s1">&#39;autoplace&#39;</span><span class="p">,</span>    <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;b&#39;</span><span class="p">,</span>            <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;baseNote&#39;</span><span class="p">,</span>     <span class="c1"># within &lt;Tuplet&gt;, ignored</span>
                <span class="s1">&#39;BarLine&#39;</span><span class="p">,</span>      <span class="c1"># stored in self.info</span>
                <span class="s1">&#39;Beam&#39;</span><span class="p">,</span>         <span class="c1"># ignored</span>
                <span class="s1">&#39;BeamMode&#39;</span><span class="p">,</span>     <span class="c1"># ignored</span>
                <span class="s1">&#39;bold&#39;</span><span class="p">,</span>         <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;bracket&#39;</span><span class="p">,</span>      <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;bracketType&#39;</span><span class="p">,</span>  <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;channelSwitch&#39;</span><span class="p">,</span><span class="c1"># playback information, ignored</span>
                <span class="s1">&#39;Clef&#39;</span><span class="p">,</span>         <span class="c1"># score_feature &#39;clefs&#39;</span>
                <span class="s1">&#39;Chord&#39;</span><span class="p">,</span>        <span class="c1"># main information contained in note list</span>
                <span class="s1">&#39;Chordline&#39;</span><span class="p">,</span>    <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;concertClefType&#39;</span><span class="p">,</span> <span class="c1"># score_feature &#39;clefs&#39;</span>
                <span class="s1">&#39;direction&#39;</span><span class="p">,</span>    <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;dotPosition&#39;</span><span class="p">,</span>  <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;dots&#39;</span><span class="p">,</span>         <span class="c1"># for note duration</span>
                <span class="s1">&#39;duration&#39;</span><span class="p">,</span>     <span class="c1"># in &lt;Rest&gt;, ignored because seemed to double &lt;durationType&gt;</span>
                <span class="s1">&#39;durationType&#39;</span><span class="p">,</span> <span class="c1"># note duration</span>
                <span class="s1">&#39;Dynamic&#39;</span><span class="p">,</span>      <span class="c1"># score_feature &#39;dynamics&#39;</span>
                <span class="s1">&#39;Element&#39;</span><span class="p">,</span>      <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;endRepeat&#39;</span><span class="p">,</span>    <span class="c1"># when a repeated section ends</span>
                <span class="s1">&#39;endTuplet&#39;</span><span class="p">,</span>    <span class="c1"># used for note duration</span>
                <span class="s1">&#39;family&#39;</span><span class="p">,</span>       <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;FiguredBass&#39;</span><span class="p">,</span>  <span class="c1"># not implemented yet</span>
                <span class="s1">&#39;Fingering&#39;</span><span class="p">,</span>    <span class="c1"># ignored</span>
                <span class="s1">&#39;font&#39;</span><span class="p">,</span>         <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;fractions&#39;</span><span class="p">,</span>    <span class="c1"># duration of &lt;location&gt; (part of Spanner)</span>
                <span class="s1">&#39;grace&#39;</span><span class="p">,</span>        <span class="c1"># part of &#39;slur&#39; spanner, ignored</span>
                <span class="s1">&#39;grace4&#39;</span><span class="p">,</span><span class="s1">&#39;grace4after&#39;</span><span class="p">,</span><span class="s1">&#39;grace8&#39;</span><span class="p">,</span><span class="s1">&#39;grace8after&#39;</span><span class="p">,</span><span class="s1">&#39;grace16&#39;</span><span class="p">,</span><span class="s1">&#39;grace16after&#39;</span><span class="p">,</span>
                <span class="s1">&#39;grace32&#39;</span><span class="p">,</span><span class="s1">&#39;grace32after&#39;</span><span class="p">,</span><span class="s1">&#39;grace64&#39;</span><span class="p">,</span><span class="s1">&#39;grace64after&#39;</span><span class="p">,</span> <span class="c1"># stored in note list</span>
                <span class="s1">&#39;Harmony&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Hook&#39;</span><span class="p">,</span>         <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;i&#39;</span><span class="p">,</span>            <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;InstrumentChange&#39;</span><span class="p">,</span> <span class="c1"># ignored</span>
                <span class="s1">&#39;irregular&#39;</span><span class="p">,</span>    <span class="c1"># measure exluded from bar count</span>
                <span class="s1">&#39;italic&#39;</span><span class="p">,</span>       <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;Jump&#39;</span><span class="p">,</span>         <span class="c1"># score features &#39;texts&#39; and &#39;jumps&#39;</span>
                <span class="s1">&#39;KeySig&#39;</span><span class="p">,</span>       <span class="c1"># Key signature</span>
                <span class="s1">&#39;LayoutBreak&#39;</span><span class="p">,</span>  <span class="c1"># subtype &#39;section&#39; taken into account for repeat structure</span>
                <span class="s1">&#39;Lyrics&#39;</span><span class="p">,</span>       <span class="c1"># score_feature &#39;lyrics&#39;</span>
                <span class="s1">&#39;location&#39;</span><span class="p">,</span>     <span class="c1"># between &lt;Chord&gt; to replace hidden rest (or within &lt;Volta&gt;)</span>
                <span class="s1">&#39;Marker&#39;</span><span class="p">,</span>       <span class="c1"># score feature &#39;jumps&#39;</span>
                <span class="s1">&#39;Measure&#39;</span><span class="p">,</span>
                <span class="s1">&#39;measures&#39;</span><span class="p">,</span>     <span class="c1"># within &lt;next&gt; within &lt;Volta&gt;</span>
                <span class="s1">&#39;minDistance&#39;</span><span class="p">,</span>  <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;name&#39;</span><span class="p">,</span>         <span class="c1"># score feature &#39;chords&#39;</span>
                <span class="s1">&#39;next&#39;</span><span class="p">,</span>         <span class="c1"># within &lt;Volta&gt;</span>
                <span class="s1">&#39;noOffset&#39;</span><span class="p">,</span>     <span class="c1"># vlue to add to bar count from here on</span>
                <span class="s1">&#39;normalNotes&#39;</span><span class="p">,</span>  <span class="c1"># within &lt;Tuplet&gt;</span>
                <span class="s1">&#39;Note&#39;</span><span class="p">,</span>         <span class="c1"># within &lt;Chord&gt;</span>
                <span class="s1">&#39;notes&#39;</span><span class="p">,</span>        <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;NoteDot&#39;</span><span class="p">,</span>      <span class="c1"># layout information about dots, ignored</span>
                <span class="s1">&#39;noStem&#39;</span><span class="p">,</span>       <span class="c1"># layout information, ignore</span>
                <span class="s1">&#39;Number&#39;</span><span class="p">,</span>       <span class="c1"># within &lt;Tuplet&gt;, ignored</span>
                <span class="s1">&#39;o1&#39;</span><span class="p">,</span><span class="s1">&#39;o2&#39;</span><span class="p">,</span><span class="s1">&#39;o3&#39;</span><span class="p">,</span><span class="s1">&#39;o4&#39;</span><span class="p">,</span> <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;offset&#39;</span><span class="p">,</span>       <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="s1">&#39;p2&#39;</span><span class="p">,</span>     <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;Path&#39;</span><span class="p">,</span>         <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;pitch&#39;</span><span class="p">,</span>
                <span class="s1">&#39;placement&#39;</span><span class="p">,</span>    <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;prev&#39;</span><span class="p">,</span>         <span class="c1"># within &lt;Volta&gt;, ignored</span>
                <span class="s1">&#39;RehearsalMark&#39;</span><span class="p">,</span><span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;Rest&#39;</span><span class="p">,</span>         <span class="c1"># only used to calculate positions but not stored as events</span>
                <span class="s1">&#39;role&#39;</span><span class="p">,</span>         <span class="c1"># part of &lt;Accidental&gt;, ignored</span>
                <span class="s1">&#39;size&#39;</span><span class="p">,</span>         <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;Slur&#39;</span><span class="p">,</span>         <span class="c1"># ignored</span>
                <span class="s1">&#39;SlurSegment&#39;</span><span class="p">,</span>  <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;small&#39;</span><span class="p">,</span>        <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;Spanner&#39;</span><span class="p">,</span>      <span class="c1"># several cases; used: &quot;Tie&quot; (test 8va)</span>
                <span class="s1">&#39;staffMove&#39;</span><span class="p">,</span>    <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;StaffText&#39;</span><span class="p">,</span>    <span class="c1"># score_feature &#39;texts&#39;</span>
                <span class="s1">&#39;StaffTypeChange&#39;</span><span class="p">,</span> <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;startRepeat&#39;</span><span class="p">,</span>  <span class="c1"># when a repeated section begins</span>
                <span class="s1">&#39;Stem&#39;</span><span class="p">,</span>         <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;StemDirection&#39;</span><span class="p">,</span><span class="c1"># ignored</span>
                <span class="s1">&#39;straight&#39;</span><span class="p">,</span>     <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;stretch&#39;</span><span class="p">,</span>      <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;style&#39;</span><span class="p">,</span>        <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;subtype&#39;</span><span class="p">,</span>      <span class="c1"># part of &lt;Articulation&gt;, &lt;BarLine&gt;, &lt;Dynamic&gt;</span>
                <span class="s1">&#39;swing&#39;</span><span class="p">,</span>        <span class="c1"># playback information, ignored</span>
                <span class="s1">&#39;Symbol&#39;</span><span class="p">,</span>       <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;SystemText&#39;</span><span class="p">,</span>   <span class="c1"># score_feature &#39;texts&#39;</span>
                <span class="s1">&#39;Tempo&#39;</span><span class="p">,</span>        <span class="c1"># playback information, ignored</span>
                <span class="s1">&#39;text&#39;</span><span class="p">,</span>         <span class="c1"># part of &lt;Lyrics&gt; &lt;StaffText&gt; &lt;SystemText&gt;</span>
                <span class="s1">&#39;Tie&#39;</span><span class="p">,</span>          <span class="c1"># see Spanner</span>
                <span class="s1">&#39;TieSegment&#39;</span><span class="p">,</span>   <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;TimeSig&#39;</span><span class="p">,</span>      <span class="c1"># stored in self.info</span>
                <span class="s1">&#39;tpc&#39;</span><span class="p">,</span>          <span class="c1"># Tonal pitch class C = 0, F = -1, Bb = -2, G = 1,</span>
                                <span class="c1"># D = 2 etc. (i.e. MuseScore format minus 14: https://musescore.org/en/plugin-development/tonal-pitch-class-enum)</span>
                <span class="s1">&#39;transposingClefType&#39;</span><span class="p">,</span> <span class="c1"># ignored, usually a doubling of concertClefType</span>
                <span class="s1">&#39;tuning&#39;</span><span class="p">,</span>       <span class="c1"># playback information, ignored</span>
                <span class="s1">&#39;Tuplet&#39;</span><span class="p">,</span>       <span class="c1"># for note duration</span>
                <span class="s1">&#39;up&#39;</span><span class="p">,</span>           <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;userLen&#39;</span><span class="p">,</span>      <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;userLen1&#39;</span><span class="p">,</span>     <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;userLen2&#39;</span><span class="p">,</span>     <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;velocity&#39;</span><span class="p">,</span>     <span class="c1"># playback information, ignored</span>
                <span class="s1">&#39;veloType&#39;</span><span class="p">,</span>     <span class="c1"># playback information, ignored</span>
                <span class="s1">&#39;visible&#39;</span><span class="p">,</span>      <span class="c1"># ignored</span>
                <span class="s1">&#39;voice&#39;</span><span class="p">,</span>        <span class="c1"># stored in note list</span>
                <span class="s1">&#39;voices&#39;</span><span class="p">,</span>       <span class="c1"># part of &#39;slur&#39; spanner, ignored</span>
                <span class="s1">&#39;Volta&#39;</span><span class="p">,</span>
                <span class="s1">&#39;vspacerUp&#39;</span><span class="p">,</span>    <span class="c1"># layout information, ignored</span>
                <span class="s1">&#39;vspacerDown&#39;</span><span class="p">,</span>  <span class="c1"># layout information, ignored</span>
                <span class="p">]</span>


<span class="c1">################################################################################</span>
<span class="c1">#                     HELPER FUNCTIONS in alphabetical order</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="a_n_range"><a class="viewcode-back" href="../ms3.html#ms3.a_n_range">[docs]</a><span class="k">def</span> <span class="nf">a_n_range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates character `a` and the `n-1` following characters.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    c : :obj:`char`</span>
<span class="sd">        Start character.</span>
<span class="sd">    n : :obj:`int`</span>
<span class="sd">        Number of total characters.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; list(a_n_range(&#39;b&#39;, 4))</span>
<span class="sd">    [&#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">+</span><span class="n">n</span><span class="p">):</span>
        <span class="k">yield</span> <span class="nb">chr</span><span class="p">(</span><span class="n">a</span><span class="p">)</span></div>



<div class="viewcode-block" id="apply_function"><a class="viewcode-back" href="../ms3.html#ms3.apply_function">[docs]</a><span class="k">def</span> <span class="nf">apply_function</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Applies function f to a collection.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">set</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="check_measure_boundaries"><a class="viewcode-back" href="../ms3.html#ms3.check_measure_boundaries">[docs]</a><span class="k">def</span> <span class="nf">check_measure_boundaries</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">measure_durations</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check that no note surpasses the barline and log errors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    notes : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame with columns [&#39;mc&#39;, &#39;onset&#39;, &#39;duration&#39;]</span>
<span class="sd">    measure_durations : :obj:`pandas.Series`</span>
<span class="sd">        A series where the index matches notes.mc</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `None`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">OK</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">mc</span><span class="p">,</span> <span class="n">onset</span><span class="p">,</span> <span class="n">duration</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">[[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;onset&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">onset</span> <span class="o">+</span> <span class="n">duration</span> <span class="o">&gt;</span> <span class="n">measure_durations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mc</span><span class="p">]:</span>
            <span class="n">OK</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="c1"># single index</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">ix</span> <span class="o">=</span> <span class="n">ix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># multiindex</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Event </span><span class="si">{ix}</span><span class="s2"> in MC </span><span class="si">{mc}</span><span class="s2"> has has duration </span><span class="si">{duration}</span><span class="s2"> and starts on </span><span class="si">{onset}</span><span class="s2">, surpassing the measure length of </span><span class="si">{measure_durations.loc[mc]}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">OK</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Measure boundaries checked: No errors.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_mn"><a class="viewcode-back" href="../ms3.html#ms3.check_mn">[docs]</a><span class="k">def</span> <span class="nf">check_mn</span><span class="p">(</span><span class="n">mn_series</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check measure numbers for gaps and overlaps and logs errors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mn_series : :obj:`pandas.Series`</span>
<span class="sd">        Series of measure numbers.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `None`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check that numbers are strictly ascending</span>
    <span class="n">ensure_ascending</span> <span class="o">=</span> <span class="n">mn_series</span> <span class="o">&lt;</span> <span class="n">mn_series</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ensure_ascending</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">ixs</span> <span class="o">=</span> <span class="n">mn_series</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ensure_ascending</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Score contains descending barnumbers at measure count{&#39;s &#39; if len(ixs) &gt; 1 else &#39; &#39;}{&#39;, &#39;.join([str(i) for i in ixs])}, possibly caused by MuseScore&#39;s &#39;Add to bar number&#39; function.&quot;</span><span class="p">)</span>
    <span class="c1"># Check for numbering gaps</span>
    <span class="n">highest</span> <span class="o">=</span> <span class="n">mn_series</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">highest</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mn_series</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;The score has a numbering gap, these measure numbers are missing: </span><span class="si">{missing}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="is_smaller_version"><a class="viewcode-back" href="../ms3.html#ms3.is_smaller_version">[docs]</a><span class="k">def</span> <span class="nf">is_smaller_version</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; &#39;3.3.0&#39; &lt; &#39;3.3.4&#39; =&gt; True&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">),</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="compute_mn"><a class="viewcode-back" href="../ms3.html#ms3.compute_mn">[docs]</a><span class="k">def</span> <span class="nf">compute_mn</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Df with first column for excluded measures and facultative second column</span>
<span class="sd">       for offset (&quot;add to bar count&quot;); measure counts in the index.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">        &gt;&gt;&gt; df</span>
<span class="sd">        	dont_count	numbering_offset</span>
<span class="sd">        0	NaN	        NaN</span>
<span class="sd">        1	1	        NaN</span>
<span class="sd">        2	NaN	        NaN</span>
<span class="sd">        3	NaN	        -1</span>
<span class="sd">        4	NaN	        NaN</span>
<span class="sd">        &gt;&gt;&gt; compute_mn(df)</span>
<span class="sd">        0    1</span>
<span class="sd">        1    1</span>
<span class="sd">        2    2</span>
<span class="sd">        3    2</span>
<span class="sd">        4    3</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="n">excluded</span> <span class="o">=</span> <span class="n">df</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">excluded</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">offset</span>   <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">ix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="n">regular_ix</span> <span class="o">=</span> <span class="n">ix</span><span class="p">[</span><span class="n">excluded</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
    <span class="n">mn</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">regular_ix</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">regular_ix</span><span class="p">)</span>
    <span class="n">mn</span> <span class="o">=</span> <span class="n">mn</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">isnan</span><span class="p">(</span><span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>   <span class="c1"># if anacrusis</span>
        <span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">mn</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">offset</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">isnan</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
        <span class="n">mn</span> <span class="o">+=</span> <span class="n">offset</span>
    <span class="n">mn</span> <span class="o">=</span> <span class="n">mn</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
        <span class="n">check_mn</span><span class="p">(</span><span class="n">mn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mn</span></div>



<div class="viewcode-block" id="compute_repeat_structure"><a class="viewcode-back" href="../ms3.html#ms3.compute_repeat_structure">[docs]</a><span class="k">def</span> <span class="nf">compute_repeat_structure</span><span class="p">(</span><span class="n">mc_repeats_volta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Needs to have the two columns [&#39;repeats&#39;, &#39;volta&#39;] where for every measure count</span>
<span class="sd">        in the index a tag {&#39;startRepeat&#39;, &#39;endRepeat&#39;, &#39;firstMeasure&#39;, &#39;lastMeasure&#39;}</span>
<span class="sd">        and/or a volta number (typically {1, 2, 3}) is given.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`list` of :obj:`tuple` of :obj:`int`</span>
<span class="sd">        Beginning and ending measure counts of repeated sections.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">        &gt;&gt;&gt; df</span>
<span class="sd">                repeats	        volta</span>
<span class="sd">        0	firstMeasure	 NaN</span>
<span class="sd">        16	NaN	            1</span>
<span class="sd">        17	endRepeat	    1</span>
<span class="sd">        18	NaN	            2</span>
<span class="sd">        19	startRepeat	    NaN</span>
<span class="sd">        23	endRepeat	    1</span>
<span class="sd">        24	endRepeat	    2</span>
<span class="sd">        25	NaN	            3</span>
<span class="sd">        31	startRepeat	    NaN</span>
<span class="sd">        39	endRepeat	    1</span>
<span class="sd">        40	NaN	            2</span>
<span class="sd">        &gt;&gt;&gt; compute_repeat_structure(df)</span>
<span class="sd">        [(0, 18), (19, 25), (31, 40)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">mc_repeats_volta</span><span class="p">[[</span><span class="s1">&#39;repeats&#39;</span><span class="p">,</span> <span class="s1">&#39;volta&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> <span class="c1"># -&gt; 3 columns: [indexname, &#39;repeats&#39;, &#39;volta&#39;]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">repeats</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">|</span> <span class="n">df</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
    <span class="n">last_row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">last_row</span><span class="o">.</span><span class="n">repeats</span> <span class="o">==</span> <span class="s1">&#39;lastMeasure&#39;</span> <span class="ow">and</span> <span class="n">isnan</span><span class="p">(</span><span class="n">last_row</span><span class="o">.</span><span class="n">volta</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># Check whether beginning is an implicit startRepeat</span>
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;firstMeasure&#39;</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">isnan</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;endRepeat&#39;</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;startRepeat&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="n">startRepeats</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">repeats</span> <span class="o">==</span> <span class="s1">&#39;startRepeat&#39;</span>
    <span class="n">start_mcs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">startRepeats</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="c1"># measure counts of startRepeats</span>
    <span class="n">endRepeats</span> <span class="o">=</span> <span class="n">startRepeats</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">endRepeats</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">end_mcs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">endRepeats</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">start_mcs</span><span class="p">,</span> <span class="n">end_mcs</span><span class="p">))</span></div>


<div class="viewcode-block" id="convert_timesig"><a class="viewcode-back" href="../ms3.html#ms3.convert_timesig">[docs]</a><span class="k">def</span> <span class="nf">convert_timesig</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turns a TimeSig-tag into a fraction. If you pass a list of tags, all need</span>
<span class="sd">    to represent the same time signature. In case of errors, None is returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tag : :class:`bs4.element.Tag` (or :obj:`list`)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`fractions.Fraction`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">convert_timesig</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tag</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;List of timesignatures did not yield any result.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;List contains two different time signatures.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;TimeSig&#39;</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;sigN&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TimeSig tag has no sigN tag.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;sigD&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">D</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TimeSig tag has no sigD tag.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{N}</span><span class="s2">/</span><span class="si">{D}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="n">tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;TimeSig&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">convert_timesig</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;TimeSig&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Does not contain &lt;TimeSig&gt; tag.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="disambiguate_repeats"><a class="viewcode-back" href="../ms3.html#ms3.disambiguate_repeats">[docs]</a><span class="k">def</span> <span class="nf">disambiguate_repeats</span><span class="p">(</span><span class="n">treated</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span>
    <span class="n">multiples</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multiples</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">treated</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">a_n_range</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">multiples</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{s}</span><span class="s2">{next(new_keys[s])}&quot;</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">new_keys</span> <span class="k">else</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">treated</span><span class="p">]</span></div>



<div class="viewcode-block" id="feature_from_node"><a class="viewcode-back" href="../ms3.html#ms3.feature_from_node">[docs]</a><span class="k">def</span> <span class="nf">feature_from_node</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets a tag name and a list of corresponding tags and</span>
<span class="sd">    computes a useful value from it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tag : :obj:`str`</span>
<span class="sd">        Tag name</span>
<span class="sd">    nodes : :obj:`list` of :class:`bs4.element.Tag` (or :obj:`list`)</span>
<span class="sd">        Tags from which to extract values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Got empty node list. This shouldn&#39;t have happened:</span>
<span class="s2">check construction of defaultdict &#39;infos&#39; in function get_measure_infos&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;voice&#39;</span><span class="p">:</span>
        <span class="n">multiples</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">multiples</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;voice&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">multiples</span><span class="p">:</span>
        <span class="n">other_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature_from_node</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">send_out</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">multiples</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;{len(nodes)} </span><span class="si">{tag}</span><span class="s2">-nodes in one &lt;Measure&gt;. Used first (</span><span class="si">{val}</span><span class="s2">), ignored </span><span class="si">{other_vals}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;accidental&#39;</span><span class="p">,</span> <span class="s1">&#39;noOffset&#39;</span><span class="p">,</span> <span class="s1">&#39;irregular&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">send_out</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Empty node: </span><span class="si">{node}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;TimeSig&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">convert_timesig</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">send_out</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;endRepeat&#39;</span><span class="p">,</span> <span class="s1">&#39;startRepeat&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">send_out</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;Volta&#39;</span><span class="p">:</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">location</span>
        <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">loc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;fractions&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">loc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;measures&#39;</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">loc</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Length of volta </span><span class="si">{node}</span><span class="s2"> not specified.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">send_out</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;BarLine&#39;</span><span class="p">:</span>
        <span class="n">subtype</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;subtype&#39;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">subtype</span><span class="o">.</span><span class="n">string</span> <span class="k">if</span> <span class="n">subtype</span> <span class="k">else</span> <span class="s1">&#39;other&#39;</span>
        <span class="k">return</span> <span class="n">send_out</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;Marker&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">string</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="k">return</span> <span class="n">send_out</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Treatment of </span><span class="si">{tag}</span><span class="s2">-tags not implemented.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_volta_structure"><a class="viewcode-back" href="../ms3.html#ms3.get_volta_structure">[docs]</a><span class="k">def</span> <span class="nf">get_volta_structure</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Needs to have the two columns [&#39;repeats&#39;, &#39;volta&#39;] where for every measure count</span>
<span class="sd">        in the index a tag {&#39;startRepeat&#39;, &#39;endRepeat&#39;, &#39;firstMeasure&#39;, &#39;lastMeasure&#39;}</span>
<span class="sd">        and/or a volta number (typically {1, 2, 3}) is given.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`list` of :obj:`list` of :obj:`list` of :obj:`int`</span>
<span class="sd">        For every volta group, one list of integers per volta containing the measure</span>
<span class="sd">        counts that this volta spans.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">OK</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">repeats</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">repeats</span>
    <span class="n">voltas</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">volta_structure</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nxt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">voltas</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">volta_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">)))</span>
        <span class="n">overlaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">mc</span> <span class="k">for</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">volta_range</span> <span class="k">if</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">voltas</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">voltas</span><span class="o">.</span><span class="n">index</span><span class="o">&gt;</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlaps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plural</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlaps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Voltas overlap in MC{&#39;s&#39; if plural else &#39;&#39;} </span><span class="si">{overlaps}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">volta_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">mc</span> <span class="k">for</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">volta_range</span> <span class="k">if</span> <span class="n">mc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">overlaps</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">nxt</span><span class="p">:</span>    <span class="c1"># new volta group</span>
            <span class="n">volta_structure</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">volta_range</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>           <span class="c1"># extend volta group</span>
            <span class="n">volta_structure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volta_range</span><span class="p">)</span>
        <span class="n">nxt</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">volta_range</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;startRepeat&#39;</span> <span class="ow">in</span> <span class="n">repeats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">volta_range</span><span class="p">,]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Volta with range </span><span class="si">{volta_range}</span><span class="s2"> contains startRepeat!&quot;</span><span class="p">)</span>
            <span class="n">OK</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Check if voltas in same group have the same length</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">volta_structure</span><span class="p">:</span>
        <span class="n">I</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">I</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volta_range</span><span class="p">)</span> <span class="o">==</span> <span class="n">l</span> <span class="k">for</span> <span class="n">volta_range</span> <span class="ow">in</span> <span class="n">I</span><span class="p">):</span>
            <span class="n">except_first</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">:],[])</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">dont_count</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">except_first</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&quot;&quot;Voltas with measure COUNTS </span><span class="si">{group}</span><span class="s2"> have different lengths.</span>
<span class="s2">Check measure NUMBERS with authoritative score. To silence the warning, either make all voltas</span>
<span class="s2">the same length or exclude all measures in voltas &gt; 1 from the bar count.&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="n">OK</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">OK</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Volta structure OK.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">volta_structure</span></div>


<div class="viewcode-block" id="isnan"><a class="viewcode-back" href="../ms3.html#ms3.isnan">[docs]</a><span class="k">def</span> <span class="nf">isnan</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return True if `num` is numpy.nan (not a number)&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">num</span> <span class="o">!=</span> <span class="n">num</span></div>


<div class="viewcode-block" id="nan_eq"><a class="viewcode-back" href="../ms3.html#ms3.nan_eq">[docs]</a><span class="k">def</span> <span class="nf">nan_eq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check for equality, including NaNs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a, b : Values to compare or :obj:`pandas.Series` of values to compare.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`bool` or :obj:`pandas.Series` of :obj:`bool`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span> <span class="ow">or</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;If b is a Series, a should not be a {type(b)}&quot;</span>
        <span class="k">assert</span> <span class="n">b</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;If a is a Series, b should not be a {type(b)}&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">a</span> <span class="o">!=</span> <span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">b</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span> <span class="ow">or</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isnan</span><span class="p">(</span><span class="n">b</span><span class="p">))</span></div>



<div class="viewcode-block" id="merge_tied_notes"><a class="viewcode-back" href="../ms3.html#ms3.merge_tied_notes">[docs]</a><span class="k">def</span> <span class="nf">merge_tied_notes</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; In a note list, merge tied notes to single events with accumulated durations.</span>
<span class="sd">    Input dataframe needs columns [&#39;duration&#39;, &#39;tied&#39;, &#39;midi&#39;, &#39;staff&#39;, &#39;voice&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">notna</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="n">notna</span><span class="p">[</span><span class="n">notna</span><span class="o">.</span><span class="n">tied</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">drops</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">midi</span><span class="p">,</span> <span class="n">staff</span><span class="p">,</span> <span class="n">voice</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Looks for the ending(s) and recursively accumulates.&quot;&quot;&quot;</span>
        <span class="n">dur</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ixs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">notna</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">end</span><span class="o">.</span><span class="n">tied</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">end</span><span class="o">.</span><span class="n">midi</span> <span class="o">!=</span> <span class="n">midi</span>\
                            <span class="ow">or</span> <span class="n">end</span><span class="o">.</span><span class="n">staff</span> <span class="o">!=</span> <span class="n">staff</span>\
                            <span class="ow">or</span> <span class="n">end</span><span class="o">.</span><span class="n">voice</span> <span class="o">!=</span> <span class="n">voice</span><span class="p">:</span>
           <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
           <span class="n">end</span> <span class="o">=</span> <span class="n">notna</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dur</span> <span class="o">+=</span> <span class="n">end</span><span class="o">.</span><span class="n">duration</span>
        <span class="n">ixs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end</span><span class="o">.</span><span class="n">tied</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">midi</span><span class="p">,</span> <span class="n">staff</span><span class="p">,</span> <span class="n">voice</span><span class="p">)</span>
            <span class="n">dur</span> <span class="o">+=</span> <span class="n">d</span>
            <span class="n">ixs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dur</span><span class="p">,</span> <span class="n">ixs</span>


    <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">starts</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">add_dur</span><span class="p">,</span> <span class="n">ixs</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">notna</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">midi</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">staff</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">voice</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">add_dur</span>
        <span class="n">drops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drops</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="midi2octave"><a class="viewcode-back" href="../ms3.html#ms3.midi2octave">[docs]</a><span class="k">def</span> <span class="nf">midi2octave</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns 4 for values 60-71 and correspondingly for other notes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    val : :obj:`int` or :obj:`pandas.Series` of `int`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">val</span> <span class="o">//</span> <span class="mi">12</span> <span class="o">-</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="chord_propagation"><a class="viewcode-back" href="../ms3.html#ms3.chord_propagation">[docs]</a><span class="k">def</span> <span class="nf">chord_propagation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">chord_series</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;`df` needs columns [&#39;mc&#39;, &#39;onset&#39;, &#39;chords&#39;],</span>
<span class="sd">    `chord_series` needs multiindex [&#39;mc&#39;, &#39;onset&#39;]&quot;&quot;&quot;</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;onset&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">chords</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">chord_series</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span><span class="p">,</span> <span class="n">chord_series</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;volta&#39;</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tmp</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">before_voltas</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">before_voltas</span><span class="o">.</span><span class="n">chords</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">last_chord</span> <span class="o">=</span> <span class="n">before_voltas</span><span class="o">.</span><span class="n">chords</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">volta</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">volta</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">volta</span><span class="o">==</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">isnan</span><span class="p">(</span><span class="n">volta</span><span class="o">.</span><span class="n">chords</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">volta</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">volta</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;chords&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">last_chord</span>
            <span class="n">volta</span><span class="o">.</span><span class="n">chords</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">before_voltas</span> <span class="o">=</span> <span class="n">before_voltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volta</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">before_voltas</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">chords</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tmp</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="n">df</span><span class="o">.</span><span class="n">chords</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">chords</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="search_in_list_of_tuples"><a class="viewcode-back" href="../ms3.html#ms3.search_in_list_of_tuples">[docs]</a><span class="k">def</span> <span class="nf">search_in_list_of_tuples</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a list of indices for tuples that contain `search` at position `pos`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    L : :obj:`list` of :obj:`tuple`</span>
<span class="sd">        List of tuples in which you want elements with value `search`.</span>
<span class="sd">    pos : :obj:`int`</span>
<span class="sd">        In which position of the tuples to search.</span>
<span class="sd">    search : :obj:`object`</span>
<span class="sd">        What to look for.</span>
<span class="sd">    add : :obj:`int`, opt</span>
<span class="sd">        How much you want to add to each returned index value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">add</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="n">search</span><span class="p">]</span></div>



<div class="viewcode-block" id="sort_dict"><a class="viewcode-back" href="../ms3.html#ms3.sort_dict">[docs]</a><span class="k">def</span> <span class="nf">sort_dict</span><span class="p">(</span><span class="n">D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a new dictionary with sorted keys. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">D</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">D</span><span class="p">)}</span></div>



<div class="viewcode-block" id="tpc2degree"><a class="viewcode-back" href="../ms3.html#ms3.tpc2degree">[docs]</a><span class="k">def</span> <span class="nf">tpc2degree</span><span class="p">(</span><span class="n">tpc</span><span class="p">,</span> <span class="n">major</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return scale degree of a tonal pitch class where</span>
<span class="sd">       0 = I, -1 = IV, -2 = bVII, 1 = V etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tpc</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">apply_function</span><span class="p">(</span><span class="n">tpc2degree</span><span class="p">,</span> <span class="n">tpc</span><span class="p">,</span> <span class="n">major</span><span class="o">=</span><span class="n">major</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">major</span><span class="p">:</span>
        <span class="n">tpc</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># to make the lowest name F = 0 instead of -1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tpc</span> <span class="o">-=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">tpc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tpc</span> <span class="o">//</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">tpc</span> <span class="o">//</span> <span class="mi">7</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span>
    <span class="k">return</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">PITCH_DEGREES</span><span class="p">[</span><span class="n">tpc</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span></div>



<div class="viewcode-block" id="tpc2name"><a class="viewcode-back" href="../ms3.html#ms3.tpc2name">[docs]</a><span class="k">def</span> <span class="nf">tpc2name</span><span class="p">(</span><span class="n">tpc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return name of a tonal pitch class where</span>
<span class="sd">       0 = C, -1 = F, -2 = Bb, 1 = G etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tpc</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">apply_function</span><span class="p">(</span><span class="n">tpc2name</span><span class="p">,</span> <span class="n">tpc</span><span class="p">)</span>

    <span class="n">tpc</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># to make the lowest name F = 0 instead of -1</span>
    <span class="k">if</span> <span class="n">tpc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tpc</span> <span class="o">//</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">tpc</span> <span class="o">//</span> <span class="mi">7</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span>
    <span class="k">return</span> <span class="n">PITCH_NAMES</span><span class="p">[</span><span class="n">tpc</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">acc</span></div>



<div class="viewcode-block" id="tpc2key"><a class="viewcode-back" href="../ms3.html#ms3.tpc2key">[docs]</a><span class="k">def</span> <span class="nf">tpc2key</span><span class="p">(</span><span class="n">tpc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the name of a key signature, e.g.</span>
<span class="sd">    0 = C/a, -1 = F/d, 6 = F#/d# etc.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tpc</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">apply_function</span><span class="p">(</span><span class="n">tpc2key</span><span class="p">,</span> <span class="n">tpc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;{tpc2name(tpc)}/{tpc2name(tpc+3).lower()}&quot;</span></div>



<div class="viewcode-block" id="tpc2pc"><a class="viewcode-back" href="../ms3.html#ms3.tpc2pc">[docs]</a><span class="k">def</span> <span class="nf">tpc2pc</span><span class="p">(</span><span class="n">tpc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn a tonal pitch class into a MIDI pitch class&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tpc</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">apply_function</span><span class="p">(</span><span class="n">tpc2pc</span><span class="p">,</span> <span class="n">tpc</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">tpc</span> <span class="o">%</span> <span class="mi">12</span></div>



<div class="viewcode-block" id="transpose_to_C"><a class="viewcode-back" href="../ms3.html#ms3.transpose_to_C">[docs]</a><span class="k">def</span> <span class="nf">transpose_to_C</span><span class="p">(</span><span class="n">note_list</span><span class="p">,</span> <span class="n">measure_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Either `note_list` needs column `keysig` or you need to pass `measure_list` with `keysig`&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;keysig&#39;</span> <span class="ow">in</span> <span class="n">note_list</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">note_list</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">MultiIndex</span> <span class="ow">and</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">note_list</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">note_list_transposed</span> <span class="o">=</span> <span class="n">note_list</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">measure_list</span><span class="p">[</span><span class="s1">&#39;keysig&#39;</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;mc&#39;</span><span class="p">],</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">note_list_transposed</span> <span class="o">=</span> <span class="n">note_list</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">measure_list</span><span class="p">[</span><span class="s1">&#39;keysig&#39;</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># Add a column with the corresponding key signature for every note</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">note_list_transposed</span> <span class="o">=</span> <span class="n">note_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">note_list_transposed</span><span class="o">.</span><span class="n">tpc</span> <span class="o">-=</span> <span class="n">note_list_transposed</span><span class="o">.</span><span class="n">keysig</span>                                             <span class="c1"># subtract key signature from tonal pitch class (=transposition to C)</span>
    <span class="n">midi_transposition</span> <span class="o">=</span> <span class="n">tpc2pc</span><span class="p">(</span><span class="n">note_list_transposed</span><span class="o">.</span><span class="n">keysig</span><span class="p">)</span>\
                         <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="k">else</span> <span class="n">x</span> <span class="o">%</span> <span class="o">-</span><span class="mi">12</span><span class="p">)</span>                                     <span class="c1"># convert key signature to pitch class and decide whether MIDIs are shifted downwards (if &lt;= 6) or upwards</span>
    <span class="n">up_or_down</span> <span class="o">=</span> <span class="p">(</span><span class="n">midi_transposition</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>                                                              <span class="c1"># if the shift is 6, the direction of shift depends on the key signature:</span>
    <span class="n">midi_transposition</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">up_or_down</span><span class="p">]</span> <span class="o">=</span> <span class="n">note_list_transposed</span><span class="p">[</span><span class="n">up_or_down</span><span class="p">]</span><span class="o">.</span><span class="n">keysig</span>\
                                         <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">6</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">6</span><span class="p">)</span>                           <span class="c1"># If the key signature is F#, shift downwards, if it&#39;s Gb, shift upwards</span>
    <span class="n">note_list_transposed</span><span class="o">.</span><span class="n">midi</span> <span class="o">-=</span> <span class="n">midi_transposition</span>
    <span class="k">return</span> <span class="n">note_list_transposed</span></div>



<div class="viewcode-block" id="treat_section_index"><a class="viewcode-back" href="../ms3.html#ms3.treat_section_index">[docs]</a><span class="k">def</span> <span class="nf">treat_section_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether the index exists and convert negative index.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    i: (`collection` of) :obj:`int`</span>
<span class="sd">        Section index/indices to treat.</span>
<span class="sd">    n: :obj:`int`:</span>
<span class="sd">        Number of available sections.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">treated</span> <span class="o">=</span> <span class="p">[</span><span class="n">treat_section_index</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Error in input </span><span class="si">{i}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">treated</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">n</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Section </span><span class="si">{i}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">n</span> <span class="o">+</span> <span class="n">i</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Section </span><span class="si">{i}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">i</span></div>



<span class="c1">################################################################################</span>
<span class="c1">#                             SECTION CLASS</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="Section"><a class="viewcode-back" href="../ms3.html#ms3.Section">[docs]</a><span class="k">class</span> <span class="nc">Section</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Holds the properties of a section.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    first_mc, last_mc : :obj:`int`</span>
<span class="sd">        Measure counts of the section&#39;s first and last measure nodes.</span>
<span class="sd">    first_mn, last_mn : :obj:`int`</span>
<span class="sd">        First and last measure number as shown in the score.</span>
<span class="sd">    start_break, end_break : :obj:`str`</span>
<span class="sd">        What causes the section breaks at either side.</span>
<span class="sd">    index : :obj:`int`</span>
<span class="sd">        Index (running number) of this section.</span>
<span class="sd">    notes : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame holding all notes and their features.</span>
<span class="sd">    parent : :obj:`Score`</span>
<span class="sd">        The parent `Score` object that is creating this section.</span>
<span class="sd">    previous_section, next_section : :obj:`int`</span>
<span class="sd">        Indices of the previous and following sections in the score.</span>
<span class="sd">    repeated : :obj:`bool`</span>
<span class="sd">        Whether or not this section is repeated.</span>
<span class="sd">    subsection_of : :obj:`int`</span>
<span class="sd">        If section is a subsection, the index of the super_section, None otherwise.</span>
<span class="sd">    voltas : :obj:`list` of :obj:`range`</span>
<span class="sd">        Ranges of voltas. Default: empty list</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">first_mc</span><span class="p">,</span> <span class="n">last_mc</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">repeated</span><span class="p">,</span> <span class="n">start_break</span><span class="p">,</span> <span class="n">end_break</span><span class="p">,</span> <span class="n">voltas</span><span class="o">=</span><span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_mc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_mc</span> <span class="o">=</span> <span class="n">first_mc</span><span class="p">,</span> <span class="n">last_mc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_mn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_mn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeated</span> <span class="o">=</span> <span class="n">repeated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_break</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_break</span> <span class="o">=</span> <span class="n">start_break</span><span class="p">,</span> <span class="n">end_break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voltas</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">voltas</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">voltas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsection_of</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mn&#39;</span><span class="p">,</span> <span class="s1">&#39;onset&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;gracenote&#39;</span><span class="p">,</span> <span class="s1">&#39;nominal_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;scalar&#39;</span><span class="p">,</span> <span class="s1">&#39;tied&#39;</span><span class="p">,</span> <span class="s1">&#39;tpc&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">,</span> <span class="s1">&#39;volta&#39;</span><span class="p">]</span>
        <span class="c1"># this deals with additional features that have been requested and stored in parent.score_features</span>
        <span class="n">before_chord_tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;chords&#39;</span><span class="p">:</span>       <span class="p">[</span><span class="s1">&#39;Harmony&#39;</span><span class="p">],</span>
                             <span class="s1">&#39;clefs&#39;</span><span class="p">:</span>        <span class="p">[</span><span class="s1">&#39;Clef&#39;</span><span class="p">],</span>
                             <span class="s1">&#39;dynamics&#39;</span><span class="p">:</span>     <span class="p">[</span><span class="s1">&#39;Dynamic&#39;</span><span class="p">],</span>
                             <span class="s1">&#39;texts&#39;</span><span class="p">:</span>        <span class="p">[</span><span class="s1">&#39;StaffText&#39;</span><span class="p">,</span> <span class="s1">&#39;SystemText&#39;</span><span class="p">,</span> <span class="s1">&#39;Jump&#39;</span><span class="p">],}</span>
        <span class="n">within_chord_tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;articulation&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Articulation&#39;</span><span class="p">],</span>
                             <span class="s1">&#39;lyrics&#39;</span><span class="p">:</span>       <span class="p">[</span><span class="s1">&#39;Lyrics&#39;</span><span class="p">]}</span>
        <span class="n">found_flags</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">within_chord_tags</span><span class="p">}</span>

        <span class="k">def</span> <span class="nf">score_feature_value</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;for before_chord_tags return tuple,</span>
<span class="sd">               for within_chord_tags return dict</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Articulation&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;articulation&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">subtype</span><span class="o">.</span><span class="n">string</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Clef&#39;</span><span class="p">:</span>
                <span class="n">clef</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">concertClefType</span><span class="o">.</span><span class="n">string</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">transposingClefType</span><span class="o">.</span><span class="n">string</span> <span class="o">!=</span> <span class="n">clef</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Contains deviating keys in transposing parts.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;clefs&#39;</span><span class="p">,</span> <span class="n">clef</span>
            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Dynamic&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;dynamics&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">subtype</span><span class="o">.</span><span class="n">string</span>
            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Harmony&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;chords&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">string</span>
            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Lyrics&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;lyrics&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">string</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;StaffText&#39;</span><span class="p">,</span> <span class="s1">&#39;SystemText&#39;</span><span class="p">,</span> <span class="s1">&#39;Jump&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;texts&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Score feature </span><span class="si">{node.name}</span><span class="s2"> not implemented.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>

        <span class="n">before_chord_features</span><span class="p">,</span> <span class="n">within_chord_features</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="n">score_features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;articulation&#39;</span><span class="p">,</span> <span class="s1">&#39;chords&#39;</span><span class="p">,</span> <span class="s1">&#39;clefs&#39;</span><span class="p">,</span> <span class="s1">&#39;dynamics&#39;</span><span class="p">,</span> <span class="s1">&#39;lyrics&#39;</span><span class="p">,</span> <span class="s1">&#39;texts&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">score_features</span><span class="p">:</span>
                <span class="n">score_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">before_chord_tags</span><span class="p">:</span>
                    <span class="n">before_chord_features</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">within_chord_features</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">notes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">features</span> <span class="o">+</span> <span class="n">score_features</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previous_section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">next_section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previous_section</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_section</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="c1"># Parse all measures contained in this section</span>
        <span class="k">def</span> <span class="nf">get_feature_value</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">note</span>
            <span class="k">if</span>   <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;mc&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mc</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;mn&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mc_info</span><span class="o">.</span><span class="n">mn</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;staff&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">staff_id</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;voice&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">voice</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;onset&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pointer</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;duration&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">grace</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">duration</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;nominal_duration&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">nominal_duration</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;gracenote&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">gracenote</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;scalar&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dotscalar</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;tpc&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">tpc</span><span class="o">.</span><span class="n">string</span><span class="p">)</span> <span class="o">-</span> <span class="mi">14</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;midi&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;volta&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">volta</span>
            <span class="c1"># elif f in within_chord_features:</span>
            <span class="c1">#     return within_chord_features[f]</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;tied&#39;</span><span class="p">:</span>
                <span class="n">ties</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;Spanner&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;Tie&#39;</span><span class="p">})</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">tie</span> <span class="ow">in</span> <span class="n">ties</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">tie</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;prev&#39;</span><span class="p">):</span>
                            <span class="n">t</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>     <span class="c1"># -1: end of tie</span>
                        <span class="k">if</span> <span class="n">tie</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">):</span>
                            <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">tie</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>   <span class="c1">#  0: both</span>
                    <span class="k">return</span> <span class="n">t</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Requested non-standard feature </span><span class="si">{f}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">df_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="p">}</span>   <span class="c1"># to become the note list dataframe</span>
        <span class="n">sf_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;onset&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">score_features</span><span class="p">}</span> <span class="c1"># score features attached to rests</span>
        <span class="c1"># iterate through stacks of simultaneous measure nodes</span>
        <span class="k">for</span> <span class="n">mc</span><span class="p">,</span> <span class="n">measure_stack</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[[</span><span class="n">measure</span> <span class="k">for</span> <span class="n">mc</span><span class="p">,</span> <span class="n">measure</span> <span class="ow">in</span> <span class="n">node_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_mc</span> <span class="o">&lt;=</span> <span class="n">mc</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_mc</span><span class="p">]</span> <span class="k">for</span> <span class="n">node_dicts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">measure_nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()])):</span>
            <span class="n">mc</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_mc</span>
            <span class="n">nodetypes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>   <span class="c1"># keeping track of tags on the measure level</span>
            <span class="n">mc_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span>
            <span class="n">volta</span> <span class="o">=</span> <span class="n">mc_info</span><span class="o">.</span><span class="n">volta</span>
            <span class="k">for</span> <span class="n">staff_id</span><span class="p">,</span> <span class="n">measure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">measure_stack</span><span class="p">):</span>
                <span class="n">staff_id</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">measure</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="n">nodetypes</span><span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">tagtypes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>            <span class="c1"># keeping track of tags within elements on the voice level</span>
                <span class="k">if</span> <span class="s1">&#39;voice&#39;</span> <span class="ow">in</span> <span class="n">nodetypes</span><span class="p">:</span>
                    <span class="c1"># Parse all events within a voice within a measure within a staff</span>
                    <span class="k">for</span> <span class="n">voice</span><span class="p">,</span> <span class="n">voice_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodetypes</span><span class="p">[</span><span class="s1">&#39;voice&#39;</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">voice_tag</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                            <span class="n">nodetypes</span><span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                        <span class="n">voice</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">pointer</span> <span class="o">=</span> <span class="n">frac</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">scalar</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># to manipulate note durations</span>
                        <span class="n">scalar_stack</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">additional_tags</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">before_chord_tags</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">before_chord_features</span><span class="p">],</span> <span class="p">[])</span>
                        <span class="n">voice_level_tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Chord&#39;</span><span class="p">,</span> <span class="s1">&#39;Rest&#39;</span><span class="p">,</span> <span class="s1">&#39;Tuplet&#39;</span><span class="p">,</span> <span class="s1">&#39;endTuplet&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">additional_tags</span>
                        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">voice_tag</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">voice_level_tags</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                                <span class="n">tagtypes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Tuplet&#39;</span><span class="p">:</span>
                                <span class="n">scalar_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span>
                                <span class="n">scalar</span> <span class="o">=</span> <span class="n">scalar</span> <span class="o">*</span> <span class="n">frac</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">normalNotes</span><span class="o">.</span><span class="n">string</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">actualNotes</span><span class="o">.</span><span class="n">string</span><span class="p">))</span>
                            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;endTuplet&#39;</span><span class="p">:</span>
                                <span class="n">scalar</span> <span class="o">=</span> <span class="n">scalar_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                            <span class="c1"># additional score_features</span>
                            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">additional_tags</span><span class="p">:</span>
                                <span class="n">duration</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sf_vals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                    <span class="n">feat</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">score_feature_value</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">feat</span><span class="p">:</span>
                                        <span class="n">sf_vals</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                                    <span class="k">elif</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;onset&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">]:</span>
                                        <span class="n">sf_vals</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_feature_value</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">sf_vals</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

                            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Chord&#39;</span><span class="p">,</span> <span class="s1">&#39;Rest&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">]:</span>
                                <span class="n">grace</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;location&#39;</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">duration</span> <span class="o">=</span> <span class="n">frac</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">fractions</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;The &lt;location&gt; in mc </span><span class="si">{mc}</span><span class="s2"> has no duration given as &lt;fractions&gt;&quot;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">durationtype</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;durationType&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">string</span>
                                    <span class="k">if</span> <span class="n">durationtype</span> <span class="o">==</span> <span class="s1">&#39;measure&#39;</span><span class="p">:</span>
                                        <span class="n">dur</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">dur</span><span class="p">:</span>
                                            <span class="n">nominal_duration</span> <span class="o">=</span> <span class="n">frac</span><span class="p">(</span><span class="n">dur</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">nominal_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span><span class="o">.</span><span class="n">timesig</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">nominal_duration</span> <span class="o">=</span> <span class="n">DURATIONS</span><span class="p">[</span><span class="n">durationtype</span><span class="p">]</span>
                                    <span class="n">dots</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;dots&#39;</span><span class="p">)</span>
                                    <span class="n">dotscalar</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">frac</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dots</span><span class="o">.</span><span class="n">string</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">*</span> <span class="n">scalar</span> <span class="k">if</span> <span class="n">dots</span> <span class="k">else</span> <span class="n">scalar</span>
                                    <span class="n">duration</span> <span class="o">=</span> <span class="n">nominal_duration</span> <span class="o">*</span> <span class="n">dotscalar</span>

                                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Chord&#39;</span><span class="p">:</span>

                                    <span class="c1"># facultative features inside &lt;Chord&gt; tags</span>
                                    <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">within_chord_tags</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">within_chord_features</span><span class="p">:</span>
                                            <span class="n">found</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                                                <span class="n">within_chord_features</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">score_feature_value</span><span class="p">(</span><span class="n">found</span><span class="p">))</span>
                                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">found_flags</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
                                            <span class="n">found_flags</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>


                                    <span class="n">grace</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">find</span><span class="p">([</span><span class="s1">&#39;grace4&#39;</span><span class="p">,</span><span class="s1">&#39;grace4after&#39;</span><span class="p">,</span><span class="s1">&#39;grace8&#39;</span><span class="p">,</span><span class="s1">&#39;grace8after&#39;</span><span class="p">,</span><span class="s1">&#39;grace16&#39;</span><span class="p">,</span><span class="s1">&#39;grace16after&#39;</span><span class="p">,</span><span class="s1">&#39;grace32&#39;</span><span class="p">,</span><span class="s1">&#39;grace32after&#39;</span><span class="p">,</span><span class="s1">&#39;grace64&#39;</span><span class="p">,</span><span class="s1">&#39;grace64after&#39;</span><span class="p">,</span> <span class="s1">&#39;appoggiatura&#39;</span><span class="p">,</span> <span class="s1">&#39;acciaccatura&#39;</span><span class="p">])</span>
                                    <span class="n">gracenote</span> <span class="o">=</span> <span class="n">grace</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">grace</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                                    <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;Note&#39;</span><span class="p">):</span>
                                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">df_vals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                            <span class="n">df_vals</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_feature_value</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

                                <span class="k">if</span> <span class="ow">not</span> <span class="n">grace</span><span class="p">:</span>
                                    <span class="n">pointer</span> <span class="o">+=</span> <span class="n">duration</span>

                                    <span class="n">within_chord_features</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">within_chord_features</span><span class="p">})</span>

                                <span class="n">before_chord_features</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">before_chord_features</span><span class="p">})</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Treatment of </span><span class="si">{event.name}</span><span class="s2"> not implemented.&quot;</span><span class="p">)</span>

                    <span class="k">del</span> <span class="n">nodetypes</span><span class="p">[</span><span class="s1">&#39;voice&#39;</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Measure without &lt;voice&gt; tag.&#39;</span><span class="p">)</span>

                <span class="n">remaining_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">tagtypes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodetypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">TREATED_TAGS</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;The following tags have not been treated: </span><span class="si">{remaining_tags}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_vals</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;volta&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span> <span class="s1">&#39;tied&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">},</span> <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;onset&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">score_features</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sf_vals</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">leftovers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">leftovers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">leftovers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">def</span> <span class="nf">fill_in</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">r</span><span class="p">,</span> <span class="n">fill</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">score_features</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">isnan</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">f</span><span class="p">]):</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="n">f</span>
                    <span class="n">F</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fill</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">f</span><span class="p">]</span>
                    <span class="n">notna</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">notna</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">F</span><span class="p">[</span><span class="n">notna</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">f</span><span class="p">]</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot;-</span><span class="si">{r[f]}</span><span class="s2">&quot;</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Feature </span><span class="si">{r[f]}</span><span class="s2"> was concatenated to existing using - as separator:</span><span class="si">{NL}</span><span class="s2">{df.loc[F[notna].index, [&#39;mc&#39;, &#39;onset&#39;, &#39;staff&#39;, &#39;voice&#39;, f]]}&quot;</span><span class="p">)</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">F</span><span class="p">[</span><span class="o">~</span><span class="n">notna</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fill</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">changed</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">same_os</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">mc</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">mc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">onset</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">onset</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">same_os</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">same_staff</span> <span class="o">=</span> <span class="n">same_os</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">same_os</span><span class="o">.</span><span class="n">staff</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">staff</span><span class="p">]</span>
                <span class="n">same_voice</span> <span class="o">=</span> <span class="n">same_staff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">same_staff</span><span class="o">.</span><span class="n">voice</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">voice</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">same_voice</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fill</span> <span class="o">=</span> <span class="n">same_voice</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">same_staff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fill</span> <span class="o">=</span> <span class="n">same_staff</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fill</span> <span class="o">=</span> <span class="n">same_os</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">fill_in</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">following</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">mc</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">mc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">onset</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">onset</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">following</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">following</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">mc</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">mc</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">mc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">mc</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">mc</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">following</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">next_os</span> <span class="o">=</span> <span class="n">following</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">onset</span>
                    <span class="n">fill</span> <span class="o">=</span> <span class="n">following</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">following</span><span class="o">.</span><span class="n">onset</span> <span class="o">==</span> <span class="n">next_os</span><span class="p">]</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">fill_in</span><span class="p">()</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Feature was attached to rest, position was changed to mc </span><span class="si">{mc}</span><span class="s2">, onset </span><span class="si">{next_os}</span><span class="s2">:</span><span class="si">{NL}</span><span class="s2">{r[[&#39;mc&#39;, &#39;onset&#39;, &#39;staff&#39;, &#39;voice&#39;, f]]}&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Feature was attached to rest and hat to be moved to the next section to mc </span><span class="si">{mc}</span><span class="s2">:</span><span class="si">{NL}</span><span class="s2">{r[[&#39;mc&#39;, &#39;onset&#39;, &#39;staff&#39;, &#39;voice&#39;, f]]}&quot;</span><span class="p">)</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">mc</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">onset</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">leftovers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">leftovers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">found_flags</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">available</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">feature</span> <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">found_flags</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">flag</span><span class="p">])</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Section </span><span class="si">{self.index}</span><span class="s2"> has more features available via Score(</span><span class="si">{self.parent.filename}</span><span class="s2">, score_features=[&#39;</span><span class="si">{available}</span><span class="s2">&#39;])&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;{&#39;Repeated s&#39; if self.repeated else &#39;S&#39;}{&#39;&#39; if self.subsection_of is None else &#39;ubs&#39;}ection from MC </span><span class="si">{self.first_mc}</span><span class="s2"> (</span><span class="si">{self.start_break}</span><span class="s2">) to MC </span><span class="si">{self.last_mc}</span><span class="s2"> (</span><span class="si">{self.end_break}</span><span class="s2">), {&#39;with &#39; + str(len(self.voltas)) if len(self.voltas) &gt; 0 else &#39;without&#39;} voltas.&quot;</span></div>

<span class="c1">################################################################################</span>
<span class="c1">#                             SCORE CLASS</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="Score"><a class="viewcode-back" href="../ms3.html#ms3.Score">[docs]</a><span class="k">class</span> <span class="nc">Score</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parser for MuseScore3 MSCX files.</span>

<span class="sd">    NOTE: Measure count ``mc`` refers to the `mc` th measure node, whereas measure</span>
<span class="sd">    number ``mn`` refers to the `mn` th measure in the score. The former is the number</span>
<span class="sd">    `Bar` displayed in the MuseScore status bar, minus 1 (MS starts counting at 1,</span>
<span class="sd">    the parser at 0). The latter can consist of several measure nodes and can be</span>
<span class="sd">    split across sections.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    chord_series : :obj:`pandas.Series`</span>
<span class="sd">        If score_feature=[&#39;chords&#39;], the chords are stored in this series with multiindex [&#39;mc&#39;, &#39;onset&#39;]</span>
<span class="sd">    dir : :obj:`str`</span>
<span class="sd">        Directory where the parsed file is stored.</span>
<span class="sd">    file : :obj:`str`</span>
<span class="sd">        Absolute or relative path to the MSCX file you want to parse.</span>
<span class="sd">    filename : :obj:`str`</span>
<span class="sd">        Filename of the parsed file.</span>
<span class="sd">    info : obj:`pandas.DataFrame`</span>
<span class="sd">        Aggregation and strongly expanded version of the dataframes in `mc_info`.</span>
<span class="sd">        Useful for everyday work.</span>
<span class="sd">    last_node : :obj:`int`</span>
<span class="sd">        Measure count of the score&#39;s last measure node.</span>
<span class="sd">    leftovers : obj:`pandas.DataFrame`</span>
<span class="sd">        Temporary container holding overflowing score_features during creation of sections.</span>
<span class="sd">    mc_info : :obj:`dict` of :obj:`pandas.DataFrame`</span>
<span class="sd">        One DataFrame per staff where measure counts are index values and columns</span>
<span class="sd">        hold corresponding structural information. This information is best accessed</span>
<span class="sd">        in aggregated form in `self.info`.</span>
<span class="sd">    measure_nodes : :obj:`dict` of :obj:`dict` of :class:`bs4.element.Tag`</span>
<span class="sd">        Keys of the first dict are staff IDs, keys of each inner dict are incremental</span>
<span class="sd">        measure counts (NOT measure numbers) and values are XML nodes.</span>
<span class="sd">    score : :class:`bs4.BeautifulSoup`</span>
<span class="sd">        The complete XML structure of the parsed MSCX file.</span>
<span class="sd">    score_features : :obj:`list` of {&#39;all&#39;, &#39;articulation&#39;, &#39;chords&#39;, &#39;clefs&#39;, &#39;dynamics&#39;, &#39;jumps&#39;, &#39;lyrics&#39;, &#39;texts&#39;}</span>
<span class="sd">        Additional features you want to extract.</span>
<span class="sd">    section_order : :obj:`list` of :obj:`int`:</span>
<span class="sd">        List of section IDs representing in which order the sections in ``section_structure``</span>
<span class="sd">        are presented and repeated.</span>
<span class="sd">    section_structure : :obj:`list` of :obj:`tuple` of :obj:`int`</span>
<span class="sd">        Keys are section IDs, values are a tuple of two measure counts, the</span>
<span class="sd">        (inclusive) boundaries of the section. That is to say, no measure count</span>
<span class="sd">        can appear in two different value tuples since every measure can be part</span>
<span class="sd">        of only one section.</span>
<span class="sd">    sections : :obj:`dict` of :obj:`Section`</span>
<span class="sd">        The sections of this score.</span>
<span class="sd">    separating_barlines : :obj:`list` of :obj:`str`</span>
<span class="sd">        List of barline types that cause the score to be split in separate sections.</span>
<span class="sd">        Defaults to `[&#39;double&#39;]`.</span>
<span class="sd">    staff_nodes : :obj:`dict` of :class:`bs4.element.Tag`</span>
<span class="sd">        Keys are staff IDs starting with 1, values are XML nodes.</span>
<span class="sd">    super_sections : :obj:`dict` of :obj:`list`</span>
<span class="sd">        This dictionary has augmenting keys standing for one of the super_sections,</span>
<span class="sd">        i.e. sections that are grouped in the score by an englobing repetition,</span>
<span class="sd">        represented by lists of section IDs.</span>
<span class="sd">    super_section_order : :obj:`list` of :obj:`int`</span>
<span class="sd">        A more abstract version of section_order, using the keys from super_sections.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">score_features</span><span class="o">=</span><span class="p">[],</span> <span class="n">separating_barlines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;double&#39;</span><span class="p">]):</span>

        <span class="c1"># Initialize attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">staff_nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">score_features</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">score_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">score_features</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;all&#39;</span> <span class="ow">in</span> <span class="n">score_features</span><span class="p">:</span>
            <span class="n">score_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;articulation&#39;</span><span class="p">,</span> <span class="s1">&#39;chords&#39;</span><span class="p">,</span> <span class="s1">&#39;clefs&#39;</span><span class="p">,</span> <span class="s1">&#39;dynamics&#39;</span><span class="p">,</span> <span class="s1">&#39;jumps&#39;</span><span class="p">,</span> <span class="s1">&#39;lyrics&#39;</span><span class="p">,</span> <span class="s1">&#39;texts&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;jumps&#39;</span> <span class="ow">in</span> <span class="n">score_features</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;texts&#39;</span> <span class="ow">in</span> <span class="n">score_features</span><span class="p">:</span>
            <span class="n">score_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;texts&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_features</span> <span class="o">=</span>  <span class="n">score_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">section_structure</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">section_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">separating_barlines</span> <span class="o">=</span> <span class="n">separating_barlines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">super_sections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">super_section_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chord_series</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leftovers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Load file</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Attempting to parse </span><span class="si">{self.filename}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">bs</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39;xml&#39;</span><span class="p">)</span>

        <span class="c1"># Check Musescore version</span>
        <span class="n">ms_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;programVersion&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">string</span>
        <span class="k">if</span> <span class="n">is_smaller_version</span><span class="p">(</span><span class="n">ms_version</span><span class="p">,</span> <span class="n">NEWEST_MUSESCORE</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.filename}</span><span class="s2"> was created with MuseScore </span><span class="si">{ms_version}</span><span class="s2">. Auto-conversion will be implemented in the future.&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ms_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;This is a MS2 file, version </span><span class="si">{ms_version}</span><span class="s2">&quot;</span>
        <span class="c1"># ToDo: Auto-conversion</span>

        <span class="c1">#######################################################################</span>
        <span class="c1"># Store basic HTML nodes for quick access and extract structural info #</span>
        <span class="c1">#######################################################################</span>

        <span class="c1"># Extract staves</span>
        <span class="k">for</span> <span class="n">staff</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Part&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find_next_siblings</span><span class="p">(</span><span class="s1">&#39;Staff&#39;</span><span class="p">):</span>
            <span class="n">staff_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">staff</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">staff_nodes</span><span class="p">[</span><span class="n">staff_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">staff</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measure_nodes</span><span class="p">[</span><span class="n">staff_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Stored staff with ID </span><span class="si">{staff_id}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># Tags to extract from measures and corresponding column to store their values</span>
        <span class="c1"># in the df `self.mc_info[staff_id]` after computing them via feature_from_node().</span>
        <span class="n">tag_to_col</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accidental&#39;</span><span class="p">:</span> <span class="s1">&#39;keysig&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;TimeSig&#39;</span><span class="p">:</span> <span class="s1">&#39;timesig&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;voice&#39;</span><span class="p">:</span> <span class="s1">&#39;voices&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;startRepeat&#39;</span><span class="p">:</span> <span class="s1">&#39;repeats&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;endRepeat&#39;</span><span class="p">:</span> <span class="s1">&#39;repeats&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;LayoutBreak&#39;</span><span class="p">:</span> <span class="s1">&#39;repeats&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Volta&#39;</span><span class="p">:</span> <span class="s1">&#39;volta&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;BarLine&#39;</span><span class="p">:</span> <span class="s1">&#39;barline&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;noOffset&#39;</span><span class="p">:</span> <span class="s1">&#39;numbering_offset&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;irregular&#39;</span><span class="p">:</span> <span class="s1">&#39;dont_count&#39;</span><span class="p">,</span>
                      <span class="p">}</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;keysig&#39;</span><span class="p">,</span> <span class="s1">&#39;timesig&#39;</span><span class="p">,</span> <span class="s1">&#39;act_dur&#39;</span><span class="p">,</span> <span class="s1">&#39;voices&#39;</span><span class="p">,</span> <span class="s1">&#39;repeats&#39;</span><span class="p">,</span> <span class="s1">&#39;volta&#39;</span><span class="p">,</span> <span class="s1">&#39;barline&#39;</span><span class="p">,</span> <span class="s1">&#39;numbering_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;dont_count&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;jumps&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_features</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;marker&#39;</span><span class="p">)</span>
            <span class="n">tag_to_col</span><span class="p">[</span><span class="s1">&#39;Marker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;marker&#39;</span>

        <span class="k">def</span> <span class="nf">get_measure_infos</span><span class="p">(</span><span class="n">measure</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Treat &lt;Measure&gt; node and return info dict.&quot;&quot;&quot;</span>
            <span class="k">nonlocal</span> <span class="n">new_section</span>
            <span class="n">mc_info</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">new_section</span><span class="p">:</span>
                <span class="n">mc_info</span><span class="p">[</span><span class="s1">&#39;repeats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;newSection&#39;</span> <span class="c1"># if section starts with startRepeat, this is overwritten</span>
                <span class="n">new_section</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">measure</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;len&#39;</span><span class="p">):</span>
                <span class="n">mc_info</span><span class="p">[</span><span class="s1">&#39;act_dur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frac</span><span class="p">(</span><span class="n">measure</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">])</span>
            <span class="n">infos</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">measure</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">tag_to_col</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">infos</span><span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">infos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;LayoutBreak&#39;</span><span class="p">:</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">tag_to_col</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
                    <span class="n">mc_info</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_from_node</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">subtype</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;subtype&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">subtype</span> <span class="ow">and</span> <span class="n">subtype</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;section&#39;</span><span class="p">:</span>
                        <span class="n">new_section</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">mc_info</span>


        <span class="k">for</span> <span class="n">staff_id</span><span class="p">,</span> <span class="n">staff</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mc_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
            <span class="n">new_section</span> <span class="o">=</span> <span class="kc">False</span>    <span class="c1"># flag</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">measure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">staff</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;Measure&#39;</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">measure_nodes</span><span class="p">[</span><span class="n">staff_id</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">measure</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Stored the </span><span class="si">{i}</span><span class="s2">th measure of staff </span><span class="si">{staff_id}</span><span class="s2">.&quot;</span><span class="p">)</span>

                <span class="n">mc_info</span> <span class="o">=</span> <span class="n">mc_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_measure_infos</span><span class="p">(</span><span class="n">measure</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mc_info</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;mc&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span><span class="p">[</span><span class="n">staff_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_info</span>

        <span class="c1"># all staves should have the same number of measures</span>
        <span class="n">mcs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mcs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Staves have different measure counts. Check DataFrames in self.mc_info&quot;</span><span class="p">)</span>

        <span class="c1"># Last measure count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_node</span> <span class="o">=</span>  <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Check for infos which are not included in self.mc_info[1]; i.e.,</span>
        <span class="c1"># infos appearing only in one of the lower staves.</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;voices&#39;</span><span class="p">]:</span>    <span class="c1"># Exclude columns that will be aggregated anyway</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="n">c1</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">c1</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                        <span class="n">not_in_c1</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="o">~</span><span class="n">nan_eq</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_in_c1</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;These values in mc_info[{i+2}] are not included in mc_info[1]: </span><span class="si">{not_in_c1}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># complete the keysig and timesig infos</span>
        <span class="k">for</span> <span class="n">staff</span><span class="p">,</span> <span class="n">mc_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">first_row</span> <span class="o">=</span> <span class="n">mc_info</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">last_row</span> <span class="o">=</span> <span class="n">mc_info</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">isnan</span><span class="p">(</span><span class="n">first_row</span><span class="o">.</span><span class="n">keysig</span><span class="p">):</span>
                <span class="n">mc_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">first_row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39;keysig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Key signature has been set to C major.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isnan</span><span class="p">(</span><span class="n">first_row</span><span class="o">.</span><span class="n">timesig</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Time signature not defined in the first measure of staff </span><span class="si">{staff}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isnan</span><span class="p">(</span><span class="n">first_row</span><span class="o">.</span><span class="n">repeats</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;First measure of staff </span><span class="si">{staff}</span><span class="s2"> has a </span><span class="si">{first_row.repeats}</span><span class="s2"> tag. Information overwritten by &#39;firstMeasure&#39;&quot;</span><span class="p">)</span>
            <span class="n">mc_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;repeats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;firstMeasure&#39;</span>
            <span class="k">if</span> <span class="n">isnan</span><span class="p">(</span><span class="n">last_row</span><span class="o">.</span><span class="n">repeats</span><span class="p">):</span>
                <span class="n">mc_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">last_row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;repeats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lastMeasure&#39;</span>
            <span class="n">mc_info</span><span class="p">[[</span><span class="s1">&#39;keysig&#39;</span><span class="p">,</span> <span class="s1">&#39;timesig&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mc_info</span><span class="p">[[</span><span class="s1">&#39;keysig&#39;</span><span class="p">,</span> <span class="s1">&#39;timesig&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
            <span class="n">mc_info</span><span class="p">[</span><span class="s1">&#39;keysig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_info</span><span class="p">[</span><span class="s1">&#39;keysig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1">#######################################################################</span>
        <span class="c1"># Create the master DataFrame self.info, combining all staves&#39;        #</span>
        <span class="c1"># structural information and newly computed infos such as bar numbers #</span>
        <span class="c1">#######################################################################</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;info and mc_info[1] were identical before aggregation.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&quot;&quot;info and mc_info[1] were not identical before aggregation.</span>
<span class="s2">This means that lower staves contain information that&#39;s missing in</span>
<span class="s2">the first staff (as shown in previous warning).&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># complete measure durations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;timesig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">frac</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">act_dur</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Aggregate values in self.info</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">voices</span> <span class="o">+=</span> <span class="n">df</span><span class="o">.</span><span class="n">voices</span>


        <span class="c1">##################################################</span>
        <span class="c1"># Calculate and check measure numbers (MN != MC) #</span>
        <span class="c1">##################################################</span>
        <span class="c1"># mn are bar numbers as they are shown in MuseScore in the score</span>
        <span class="c1"># mc are bar numbers as they are shown in MuseScore in the status bar, minus one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;mn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_mn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[[</span><span class="s1">&#39;dont_count&#39;</span><span class="p">,</span><span class="s1">&#39;numbering_offset&#39;</span><span class="p">]])</span>


        <span class="c1">#############################</span>
        <span class="c1"># Compute section structure #</span>
        <span class="c1">#############################</span>

        <span class="c1"># Spreading out volta information</span>
        <span class="n">volta_structure</span> <span class="o">=</span> <span class="n">get_volta_structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">volta_structure</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mc</span><span class="p">,</span> <span class="s1">&#39;volta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>


        <span class="k">def</span> <span class="nf">create_section</span><span class="p">(</span><span class="n">fro</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">repeated</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            fro, to : `int`</span>
<span class="sd">                First and last measure count of the new section.</span>
<span class="sd">            repeated : bool, opt</span>
<span class="sd">                Whether or not the new section is repeated.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">nonlocal</span> <span class="n">section_counter</span><span class="p">,</span> <span class="n">super_counter</span>
            <span class="n">start_reason</span> <span class="o">=</span> <span class="s1">&#39;start&#39;</span> <span class="k">if</span> <span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">repeats</span><span class="p">[</span><span class="n">fro</span><span class="p">])</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">repeats</span><span class="p">[</span><span class="n">fro</span><span class="p">]</span>
            <span class="n">end_reason</span>   <span class="o">=</span> <span class="s1">&#39;end&#39;</span>   <span class="k">if</span> <span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">repeats</span><span class="p">[</span><span class="n">to</span><span class="p">])</span>  <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">repeats</span><span class="p">[</span><span class="n">to</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">start_reason</span> <span class="o">==</span> <span class="s1">&#39;start&#39;</span><span class="p">:</span>
                <span class="n">start_reason</span> <span class="o">=</span> <span class="s1">&#39;startRepeat&#39;</span> <span class="k">if</span> <span class="n">repeated</span> <span class="k">else</span> <span class="s1">&#39;startNormal&#39;</span>
            <span class="k">if</span> <span class="n">end_reason</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
                <span class="n">end_reason</span> <span class="o">=</span> <span class="s1">&#39;endRepeat&#39;</span> <span class="k">if</span> <span class="n">repeated</span> <span class="k">else</span> <span class="s1">&#39;endNormal&#39;</span>

            <span class="n">inner_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fro</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">to</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># measure infos excluding starting and ending measure</span>
            <span class="c1"># check whether this section contains separating barlines: then, subsections have to be created</span>
            <span class="n">splits</span> <span class="o">=</span> <span class="n">inner_structure</span><span class="o">.</span><span class="n">barline</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separating_barlines</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">splits</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">subsections</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">boundaries</span> <span class="o">=</span> <span class="n">inner_structure</span><span class="o">.</span><span class="n">barline</span><span class="p">[</span><span class="n">splits</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;_barline&#39;</span><span class="p">)</span>
                <span class="n">split_mcs</span> <span class="o">=</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">fro</span><span class="p">,</span> <span class="n">to</span><span class="p">]</span> <span class="o">+</span> <span class="n">split_mcs</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">split_mcs</span><span class="p">])</span>
                <span class="n">reasons</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_reason</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">reason</span> <span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">end_reason</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reasons</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bounds</span><span class="p">):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Implementation error.&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">f</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># &quot;from mc&quot; and &quot;to mc&quot; for subsections</span>
                    <span class="n">f_reason</span><span class="p">,</span> <span class="n">t_reason</span> <span class="o">=</span> <span class="n">reasons</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="n">reasons</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">section_structure</span><span class="p">[</span><span class="n">section_counter</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section_counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">section_counter</span><span class="p">,</span> <span class="n">repeated</span><span class="p">,</span> <span class="n">f_reason</span><span class="p">,</span> <span class="n">t_reason</span><span class="p">)</span>
                    <span class="n">subsections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section_counter</span><span class="p">)</span>
                    <span class="n">section_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">section_structure</span><span class="p">[</span><span class="n">section_counter</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fro</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section_counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">Section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fro</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">section_counter</span><span class="p">,</span> <span class="n">repeated</span><span class="p">,</span> <span class="n">start_reason</span><span class="p">,</span> <span class="n">end_reason</span><span class="p">)</span>
                <span class="n">subsections</span> <span class="o">=</span> <span class="p">[</span><span class="n">section_counter</span><span class="p">]</span>
                <span class="n">section_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">section_order</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subsections</span> <span class="o">*</span> <span class="p">(</span><span class="n">repeated</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">super_sections</span><span class="p">[</span><span class="n">super_counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">subsections</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subsections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subsections</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">subsection_of</span> <span class="o">=</span> <span class="n">super_counter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">super_section_order</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">super_counter</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">repeated</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">super_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Created {&#39;repeated &#39; if repeated else &#39;&#39;}section from </span><span class="si">{fro}</span><span class="s2"> to </span><span class="si">{to}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">nonlocal</span> <span class="n">last_to</span>
            <span class="n">last_to</span> <span class="o">=</span> <span class="n">to</span>
            <span class="c1">############################################ end of create_section()</span>

        <span class="c1"># Compute (from_mc, to_mc) tuples of all repeated sections and create sections</span>
        <span class="n">repeat_structure</span> <span class="o">=</span> <span class="n">compute_repeat_structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="n">last_to</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">section_counter</span><span class="p">,</span> <span class="n">super_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">to</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># In case there are no repeats</span>
        <span class="k">for</span> <span class="n">fro</span><span class="p">,</span> <span class="n">to</span> <span class="ow">in</span> <span class="n">repeat_structure</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fro</span> <span class="o">!=</span> <span class="n">last_to</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">create_section</span><span class="p">(</span><span class="n">last_to</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">fro</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>    <span class="c1"># create unrepeated section</span>
            <span class="n">create_section</span><span class="p">(</span><span class="n">fro</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>           <span class="c1"># create repeated   section</span>
        <span class="k">if</span> <span class="n">to</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_node</span><span class="p">:</span>
            <span class="n">create_section</span><span class="p">(</span><span class="n">to</span><span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">to</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_node</span><span class="p">)</span>

        <span class="c1"># Add volta groups to section objects</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">section_structure</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">section</span><span class="p">,</span> <span class="p">(</span><span class="n">fro</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">volta_structure</span><span class="p">:</span>
            <span class="n">volta_mcs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="kc">True</span> <span class="k">for</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">volta_mcs</span> <span class="k">if</span> <span class="n">mc</span> <span class="o">&gt;</span> <span class="n">to</span><span class="p">):</span>
                <span class="n">section</span><span class="p">,</span> <span class="p">(</span><span class="n">fro</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">voltas</span> <span class="o">=</span> <span class="n">group</span>

        <span class="c1"># Add sections to self.info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;section&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;Int64&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">fro</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">section_structure</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fro</span><span class="p">:</span><span class="n">to</span><span class="p">,</span> <span class="s1">&#39;section&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">section</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Not all measure nodes have been assigned to a section.&quot;</span><span class="p">)</span>

        <span class="c1"># check that no note crosses measure boundary</span>
        <span class="n">note_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_notes</span><span class="p">(</span><span class="n">volta_warning</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">propagate_chords</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">check_measure_boundaries</span><span class="p">(</span><span class="n">note_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">act_dur</span><span class="p">)</span>

        <span class="c1"># if &#39;chords&#39; are requested, store chord_series</span>
        <span class="k">if</span> <span class="s1">&#39;chords&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_features</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">note_list</span><span class="o">.</span><span class="n">chords</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">chord_series</span> <span class="o">=</span> <span class="n">note_list</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;onset&#39;</span><span class="p">,</span> <span class="s1">&#39;chords&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="s1">&#39;chords&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">chords</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">chord_series</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Doublings: </span><span class="si">{chord_series[chord_series.index.duplicated(keep=False)]}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chord_series</span> <span class="o">=</span> <span class="n">chord_series</span>

        <span class="c1"># if &#39;jumps&#39; are requested, add textual information to self.info</span>
        <span class="k">if</span> <span class="s1">&#39;jumps&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_features</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">note_list</span><span class="o">.</span><span class="n">texts</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">jumps</span> <span class="o">=</span> <span class="n">note_list</span><span class="o">.</span><span class="n">texts</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bd\.|\bda|segno|capo&#39;</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">jumps</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">mc</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">note_list</span><span class="p">[[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;texts&#39;</span><span class="p">]][</span><span class="n">jumps</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mc</span><span class="p">,</span> <span class="s1">&#39;marker&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mc</span><span class="p">,</span> <span class="s1">&#39;marker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">mc</span><span class="p">,</span> <span class="s1">&#39;marker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{val}</span><span class="s2"> &amp; </span><span class="si">{text}</span><span class="s2">&quot;</span>



        <span class="c1"># Compute the subsequent mc for every mc</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span><span class="o">*</span><span class="p">[[]],</span> <span class="n">index</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">mcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s1">&#39;mc&#39;</span><span class="p">]</span>
        <span class="n">before_volta</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">fro</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">first_mc</span><span class="p">,</span> <span class="n">section</span><span class="o">.</span><span class="n">last_mc</span>
            <span class="n">volta_mcs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">section</span><span class="o">.</span><span class="n">voltas</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">repeat_slice</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volta_mcs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                     <span class="c1"># if this section has no voltas</span>
                <span class="n">normal_slice</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">fro</span><span class="p">,</span> <span class="n">to</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># all measures are followed by +1 (&quot;normal&quot;)</span>
                <span class="k">if</span> <span class="n">section</span><span class="o">.</span><span class="n">repeated</span><span class="p">:</span>                    <span class="c1"># and when repeated, the last one</span>
                    <span class="n">repeat_slice</span> <span class="o">=</span> <span class="p">[</span><span class="n">to</span><span class="p">]</span>                 <span class="c1"># will also be followed by the section&#39;s beginning</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">normal_slice</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fro</span><span class="p">,</span> <span class="n">to</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">volta_mcs</span><span class="p">]</span>
                <span class="n">n_voltas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">section</span><span class="o">.</span><span class="n">voltas</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">section</span><span class="o">.</span><span class="n">voltas</span><span class="p">)):</span>        <span class="c1"># iterate backwards through voltas</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_voltas</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>                                    <span class="c1"># check for all voltas but the first</span>
                        <span class="n">group_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>             <span class="c1"># whether they are exluded from bar count</span>
                        <span class="n">wrongly_counted</span> <span class="o">=</span> <span class="n">group_info</span><span class="o">.</span><span class="n">dont_count</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">group_info</span><span class="o">.</span><span class="n">numbering_offset</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">wrongly_counted</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                            <span class="n">not_ex</span> <span class="o">=</span> <span class="n">mcs</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">wrongly_counted</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                            <span class="n">plural</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_ex</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;MC{&#39;s&#39; if plural else &#39;&#39;} {not_ex if plural else not_ex[0]} in volta </span><span class="si">{group}</span><span class="s2"> {&#39;have&#39; if plural else &#39;has&#39;} not been excluded from barcount.&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                                              <span class="c1"># last volta:</span>
                        <span class="n">normal_slice</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>                          <span class="c1"># just normal</span>
                        <span class="c1"># check</span>
                        <span class="n">repeat_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">repeats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">rep</span> <span class="ow">in</span> <span class="n">repeat_vals</span> <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;startRepeat&#39;</span><span class="p">,</span> <span class="s1">&#39;endRepeat&#39;</span><span class="p">]):</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Final volta with MC </span><span class="si">{group}</span><span class="s2"> contains a repeat sign.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>                                                   <span class="c1"># previous voltas:</span>
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">group</span><span class="p">)):</span>            <span class="c1"># iterate backwards through measure counts</span>
                            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                                      <span class="c1"># the last one goes back to section&#39;s beginning</span>
                                <span class="c1"># check</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mc</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">fro</span><span class="p">]]</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mc</span><span class="p">,</span> <span class="s1">&#39;repeats&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;endRepeat&#39;</span><span class="p">:</span>
                                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Volta with MC </span><span class="si">{group}</span><span class="s2"> is missing the endRepeat.&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>                                           <span class="c1"># previous MCs just normal</span>
                                <span class="n">normal_slice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mc</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">before_volta</span><span class="p">[</span><span class="n">mc</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">section</span><span class="o">.</span><span class="n">voltas</span><span class="p">]</span> <span class="c1"># store measure before the first volta and a list holding</span>
                                                                                <span class="c1"># the first measure of each volta which can follow it</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">section</span><span class="o">.</span><span class="n">voltas</span><span class="p">,</span> <span class="n">mc</span><span class="p">)</span>
        <span class="c1"># Fill the column &#39;next&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">normal_slice</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">normal_slice</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">repeat_slice</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repeat_slice</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">repeat_slice</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="p">[</span><span class="n">fro</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">before_volta</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="s1">&#39;next&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">before_volta</span><span class="p">)</span>
        <span class="c1">#self.info.loc[before_volta.keys(), &#39;volta&#39;] = 0           # this value for the bar before voltas could help to find it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_node</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># store first_mn and last_mn for all sections and correct mns in voltas</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">mn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">v</span><span class="o">.</span><span class="n">first_mn</span> <span class="o">=</span> <span class="n">mns</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">v</span><span class="o">.</span><span class="n">last_mn</span> <span class="o">=</span> <span class="n">mns</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">voltas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>                           <span class="c1"># Correct measure numbers of voltas</span>
                <span class="n">mn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">voltas</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;mn&#39;</span><span class="p">]</span>    <span class="c1"># number of the first volta</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">voltas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>                  <span class="c1"># let every volta begin with the same measure number</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mc</span><span class="p">,</span> <span class="s1">&#39;mn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mn</span>
                            <span class="n">mn</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Calculate offsets for split measures and check for correct measure numbering</span>
        <span class="n">not_excluded</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">isnan</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">dont_count</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isnan</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">numbering_offset</span><span class="p">)</span>
        <span class="n">measures_to_check</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">act_dur</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">repeats</span> <span class="o">==</span> <span class="s1">&#39;endRepeat&#39;</span><span class="p">)</span>
        <span class="n">check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">measures_to_check</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">check</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">act_dur</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">duration</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;MC </span><span class="si">{ix}</span><span class="s2"> is longer than its nominal value.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">act_dur</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">duration</span><span class="p">:</span>           <span class="c1"># endRepeat</span>
                <span class="n">next_mcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">next</span><span class="p">]</span>
                <span class="n">irregular</span> <span class="o">=</span> <span class="n">next_mcs</span><span class="o">.</span><span class="n">act_dur</span> <span class="o">!=</span> <span class="n">next_mcs</span><span class="o">.</span><span class="n">duration</span>
                <span class="k">if</span> <span class="n">irregular</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">irr_mcs</span> <span class="o">=</span> <span class="n">next_mcs</span><span class="p">[</span><span class="n">irregular</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                    <span class="n">irr_vals</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">fr</span><span class="p">)</span> <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">next_mcs</span><span class="p">[</span><span class="n">irregular</span><span class="p">]</span><span class="o">.</span><span class="n">act_dur</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
                    <span class="n">plural</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">irr_mcs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;The endRepeat in MC </span><span class="si">{ix}</span><span class="s2"> (</span><span class="si">{r.act_dur}</span><span class="s2">) is not adapted to the irregular measure length{&#39;s&#39; if plural else &#39;&#39;} in MC{&#39;s&#39; if plural else &#39;&#39;} {irr_mcs if plural else irr_mcs[0]} (</span><span class="si">{irr_vals}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                           <span class="c1"># anacrusis</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">duration</span> <span class="o">-</span> <span class="n">r</span><span class="o">.</span><span class="n">act_dur</span>
                <span class="k">if</span> <span class="n">not_excluded</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;MC </span><span class="si">{ix}</span><span class="s2"> seems to be a pickup measure but has not been excluded from bar count!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                                   <span class="c1"># incomplete measure</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                            <span class="c1"># beginning of an incomplete measure</span>
                    <span class="n">missing</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">duration</span> <span class="o">-</span> <span class="n">r</span><span class="o">.</span><span class="n">act_dur</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">isnan</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">next</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">next</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">act_dur</span> <span class="o">==</span> <span class="n">missing</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">act_dur</span>
                                <span class="k">if</span> <span class="n">not_excluded</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">n</span><span class="p">]):</span>
                                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;MC </span><span class="si">{n}</span><span class="s2"> is completing MC </span><span class="si">{ix}</span><span class="s2"> but has not been excluded from bar count!&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;MC </span><span class="si">{ix}</span><span class="s2"> (</span><span class="si">{r.act_dur}</span><span class="s2">) and MC </span><span class="si">{n}</span><span class="s2"> (</span><span class="si">{self.info.loc[n].act_dur}</span><span class="s2">) don&#39;t add up to </span><span class="si">{r.duration}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Done parsing </span><span class="si">{self.filename}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1">######################## end of __init__() #############################</span>



<div class="viewcode-block" id="Score.get_section"><a class="viewcode-back" href="../ms3.html#ms3.Score.get_section">[docs]</a>    <span class="k">def</span> <span class="nf">get_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">volta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">volta_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">propagate_chords</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        section : (`collection` of) :obj:`int`</span>
<span class="sd">            Sections of which you want to see the notes. 0 = first, -1 = last</span>
<span class="sd">            (a, b) = sections from a to b; [a, b] = sections a and b</span>
<span class="sd">            Defaults to None which shows all sections. Repeating values in a collection</span>
<span class="sd">            leads to the corresponding note lists being repeated.</span>
<span class="sd">        volta : :obj:`int`, optional</span>
<span class="sd">            Instead of section=&#39;0b&#39; you can pass section=0, volta=2 or section=0, volta=-1 (if 2 is the last)</span>
<span class="sd">        volta_warning : :obj:`bool`, optional</span>
<span class="sd">            If the requested section (e.g. `section`=8) has voltas you need to specify which volta</span>
<span class="sd">            you want, e.g. using `section`=&#39;8a&#39; or &#39;8b&#39; or `section=8, volta=-1`. It this is not specified,</span>
<span class="sd">            a warning thrown and the notes from the last volta are chosen. Set `volta_warning` to False to</span>
<span class="sd">            silence the warning and get the notes of all voltas.</span>
<span class="sd">        propagate_chords : :obj:`bool`, optional</span>
<span class="sd">            If you want to see chords only for the places where they originally appear in the score</span>
<span class="sd">            instead of spreading them up to the next chord, pass False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">section</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">section</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">no</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">section</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">96</span> <span class="c1"># &#39;a&#39; -&gt; 1, &#39;b&#39; -&gt; 2 etc.</span>
                <span class="k">if</span> <span class="n">volta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">volta</span> <span class="o">=</span> <span class="n">no</span>
                <span class="k">elif</span> <span class="n">volta</span> <span class="o">!=</span> <span class="n">no</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Parameters section=</span><span class="si">{section}</span><span class="s2"> -&gt; volta </span><span class="si">{no}</span><span class="s2"> &lt;!&gt; volta=</span><span class="si">{volta}</span><span class="s2"> are contradictory.&quot;</span><span class="p">)</span>
                <span class="n">section</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">section</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">section</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">treat_section_index</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Section </span><span class="si">{section}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">notes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;chords&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">chords</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="n">propagate_chords</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">chord_propagation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chord_series</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">isnan</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">chords</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">notes</span><span class="o">.</span><span class="n">chords</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;chords&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">prev</span><span class="p">[</span><span class="n">prev</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">chords</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The score&#39;s first section starts without any chord.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">last_volta</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">voltas</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">volta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">volta_warning</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Section </span><span class="si">{s}</span><span class="s2"> has voltas and you haven&#39;t selected any. Therefore, the last one is being returned. If you need all, pass parameter volta_warning=False.&quot;</span><span class="p">)</span>
                        <span class="n">volta</span> <span class="o">=</span> <span class="n">last_volta</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">df</span>
                <span class="k">elif</span> <span class="n">volta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">backwards</span> <span class="o">=</span> <span class="n">last_volta</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">volta</span>
                    <span class="k">if</span> <span class="n">backwards</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Section </span><span class="si">{s}</span><span class="s2"> has </span><span class="si">{last_volta}</span><span class="s2"> voltas, volta </span><span class="si">{volta}</span><span class="s2"> does not exist. Returning 1.&quot;</span><span class="p">)</span>
                        <span class="n">backwards</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">volta</span> <span class="o">=</span> <span class="n">backwards</span>
                <span class="k">elif</span> <span class="n">volta</span> <span class="o">&gt;</span> <span class="n">last_volta</span><span class="p">:</span>
                    <span class="n">volta</span> <span class="o">=</span> <span class="n">last_volta</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Section </span><span class="si">{s}</span><span class="s2"> has only </span><span class="si">{last_volta}</span><span class="s2"> voltas, volta </span><span class="si">{volta}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">volta</span> <span class="o">==</span> <span class="n">volta</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;get_section() only works for individual sections. Check input </span><span class="si">{section}</span><span class="s1">.&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Score.get_notes"><a class="viewcode-back" href="../ms3.html#ms3.Score.get_notes">[docs]</a>    <span class="k">def</span> <span class="nf">get_notes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">volta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">volta_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">multiindex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">beatsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">merge_ties</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">propagate_chords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve list of notes as a DataFrame.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        section : (`collection` of) :obj:`int`</span>
<span class="sd">            Sections of which you want to see the notes. 0 = first, -1 = last</span>
<span class="sd">            (a, b) = sections from a to b; [a, b] = sections a and b</span>
<span class="sd">            Defaults to None which shows all sections. Repeating values in a collection</span>
<span class="sd">            leads to the corresponding note lists being repeated.</span>
<span class="sd">        volta : :obj:`int`, optional</span>
<span class="sd">            Instead of section=&#39;0b&#39; you can pass section=0, volta=2 or section=0, volta=-1 (if 2 is the last)</span>
<span class="sd">        volta_warning : :obj:`bool`, optional</span>
<span class="sd">            If the requested section (e.g. `section`=8) has voltas you need to specify which volta</span>
<span class="sd">            you want, e.g. using `section`=&#39;8a&#39; or &#39;8b&#39; or `section=8, volta=-1`. It this is not specified,</span>
<span class="sd">            a warning thrown and the notes from the last volta are chosen. Set `volta_warning` to False to</span>
<span class="sd">            silence the warning and get the notes of all voltas.</span>
<span class="sd">        multiindex : :obj:`bool`, optional</span>
<span class="sd">            Is True by default, in which case section numbers are displayed as the first level of a</span>
<span class="sd">            MultiIndex and a sequential index as the second. Pass `multiindex=False` to yield a note list</span>
<span class="sd">            with a single RangeIndex.</span>
<span class="sd">        beatsize : :obj:`bool` or :obj:`dict` or `fraction`, optional</span>
<span class="sd">            Adds a column with a beat for every note.</span>
<span class="sd">            If True, the dict TIMESIG_BEAT is used to determine the beat size according to the time signature.</span>
<span class="sd">            By passing a dictionary you can overwrite or enhance the information in TIMESIG_BEAT.</span>
<span class="sd">            If you pass a fraction (such as &#39;1/4&#39;, 1/4, frac(1/4) or 0.25), this beat size is used for all time signatures.</span>
<span class="sd">        merge_ties : :obj:`bool`, optional</span>
<span class="sd">            If False (by default), all tied notes represent individual events with ties given in column `tied`.</span>
<span class="sd">            Set to False to contract tied notes to single events (durations 1/2 _ 1/4 =&gt; 3/4)</span>
<span class="sd">        propagate_chords : :obj:`bool`, optional</span>
<span class="sd">            If you want to see chords only for the places where they originally appear in the score</span>
<span class="sd">            instead of spreading them up to the next chord, pass False.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            The following columns can be added by setting them to True:</span>
<span class="sd">            * octaves</span>
<span class="sd">            * note_names</span>
<span class="sd">            * beats (control beat size via `beatsize`, use `beats` for filtering)</span>
<span class="sd">            * pcs (pitch classes 0-11)</span>
<span class="sd">            * timesig (automatically shown if `beats` is shown)</span>
<span class="sd">            These and all other columns of the notelist can be filtered by passing feature=selector.</span>
<span class="sd">            The features are {&#39;n&#39;, &#39;mc&#39;, &#39;mn&#39;, &#39;onset&#39;, &#39;duration&#39;, &#39;gracenote&#39;,</span>
<span class="sd">            &#39;nominal_duration&#39;, &#39;scalar&#39;, &#39;tied&#39;, &#39;tpc&#39;, &#39;midi&#39;, &#39;staff&#39;, &#39;voice&#39;,</span>
<span class="sd">            &#39;volta&#39;, &#39;octaves&#39;, &#39;note_names&#39;, &#39;beats&#39;} + self.score_features</span>
<span class="sd">            The selectors can be:</span>
<span class="sd">            * Single value: Only notes where `feature` equals `selector`.</span>
<span class="sd">            * 2-tuple (a,b): Slice where `a &lt;= feature &lt;= b`.</span>
<span class="sd">            * Collection: All notes where `feature` is in `selector`.</span>
<span class="sd">            * True yields all values that are not numpy.nan</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        S.get_notes()                           # all notes</span>
<span class="sd">        S.get_notes(0)                          # notes from the first section only</span>
<span class="sd">        S.get_notes(-1)                         # notes from the last section only</span>
<span class="sd">        S.get_notes((0,3))                      # sections [0,1,2,3]</span>
<span class="sd">        S.get_notes((3,0))                      # section [3,2,1,0]</span>
<span class="sd">        S.get_notes((-4,-1))                    # fourth last to last section</span>
<span class="sd">        S.get_notes(None, False)                # all notes with single RangeIndex</span>
<span class="sd">        S.get_notes(beatsize=True)              # added column with beat sizes according to time signature</span>
<span class="sd">        S.get_notes(beatsize=1/4)               # added column with every note&#39;s quarter beat</span>
<span class="sd">        S.get_notes(note_names=True)            # added column with note names</span>
<span class="sd">        S.get_notes(note_names=[&#39;A&#39;, &#39;D&#39;, &#39;G&#39;]) # Only these notenames</span>
<span class="sd">        S.get_notes(octaves=True)               # added column with notes&#39; octaves</span>
<span class="sd">        S.get_notes(octaves=(6,10))             # Only notes in octaves 6 through 10</span>
<span class="sd">        S.get_notes(pcs=True)                   # added column with (MIDI) pitch classes</span>
<span class="sd">        S.get_notes(pcs=[1,3,6,8,10])           # only black keys on the piano</span>
<span class="sd">        S.get_notes(mn=1)                       # all notes with measure number 1</span>
<span class="sd">        S.get_notes(duration=[0.5, 1])          # all notes with duration of a half or a whole note</span>
<span class="sd">        S.get_notes(duration=(0.5, 1))          # all notes with duration of a half, a whole, or in between</span>
<span class="sd">        S.get_notes(n=(0,5))                    # get first 5 notes from every section</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># Get note lists for requested sections and save as df</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">volta</span><span class="o">=</span><span class="n">volta</span><span class="p">,</span> <span class="n">volta_warning</span><span class="o">=</span><span class="n">volta_warning</span><span class="p">,</span> <span class="n">propagate_chords</span><span class="o">=</span><span class="n">propagate_chords</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">,</span> <span class="s1">&#39;ix&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">section</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">volta</span><span class="o">=</span><span class="n">volta</span><span class="p">,</span> <span class="n">volta_warning</span><span class="o">=</span><span class="n">volta_warning</span><span class="p">,</span> <span class="n">propagate_chords</span><span class="o">=</span><span class="n">propagate_chords</span><span class="p">)],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">section</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">,</span> <span class="s1">&#39;ix&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">treated</span> <span class="o">=</span> <span class="n">treat_section_index</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">section</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">fro</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">treated</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">treated</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fro</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fro</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Replaced </span><span class="si">{section[0]}</span><span class="s2"> in </span><span class="si">{section}</span><span class="s2"> by first section 0.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">to</span> <span class="o">=</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Replaced </span><span class="si">{section[1]}</span><span class="s2"> in </span><span class="si">{section}</span><span class="s2"> by last section </span><span class="si">{to}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">to</span> <span class="o">&gt;=</span> <span class="n">fro</span><span class="p">:</span>
                    <span class="n">treated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">fro</span><span class="p">,</span> <span class="n">to</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">treated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">fro</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
                <span class="n">treated</span> <span class="o">=</span> <span class="n">treat_section_index</span><span class="p">(</span><span class="n">treated</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">treated</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">treated</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">keys</span> <span class="o">=</span> <span class="n">disambiguate_repeats</span><span class="p">(</span><span class="n">treated</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">volta</span><span class="o">=</span><span class="n">volta</span><span class="p">,</span> <span class="n">volta_warning</span><span class="o">=</span><span class="n">volta_warning</span><span class="p">,</span> <span class="n">propagate_chords</span><span class="o">=</span><span class="n">propagate_chords</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">,</span> <span class="s1">&#39;ix&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># merge tied notes</span>
        <span class="k">if</span> <span class="n">merge_ties</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">merge_tied_notes</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># activate requested features</span>
        <span class="n">available_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;octaves&#39;</span><span class="p">,</span> <span class="s1">&#39;note_names&#39;</span><span class="p">,</span> <span class="s1">&#39;beats&#39;</span><span class="p">,</span> <span class="s1">&#39;pcs&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;timesig&#39;</span><span class="p">]</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">available_features</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">beatsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">features</span><span class="p">[</span><span class="s1">&#39;beats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{feature}</span><span class="s2"> is not part of the note features.&quot;</span><span class="p">)</span>
                <span class="n">features</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;beats&#39;</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="s1">&#39;timesig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># compute additional feature columns</span>
        <span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;octaves&#39;</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;octaves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">midi2octave</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">midi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;note_names&#39;</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;note_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpc2name</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tpc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;timesig&#39;</span><span class="p">]:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;timesig&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;beats&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">beatsize</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">beatsize</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="n">beatsize</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">beatsize</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">beatsizedict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">frac</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">))</span>
                <span class="n">beatsizedict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TIMESIG_BEAT</span><span class="p">)</span>
                <span class="n">beatsizedict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beatsize</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">beatsizedict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">beatsizedict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">frac</span><span class="p">(</span><span class="n">beatsizedict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">beatsize</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">frac</span><span class="p">:</span>
                <span class="n">beatsizedict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">beatsize</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">frac</span><span class="p">(</span><span class="n">beatsize</span><span class="p">)</span>
                    <span class="n">beatsizedict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Datatype of beatsize = </span><span class="si">{beatsize}</span><span class="s2"> not understood&quot;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">compute_beat</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">beatsizedict</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">timesig</span><span class="p">]</span>
                <span class="n">onset</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">onset</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">offset</span>
                <span class="n">beat</span> <span class="o">=</span> <span class="n">onset</span> <span class="o">//</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">subbeat</span> <span class="o">=</span> <span class="p">(</span><span class="n">onset</span> <span class="o">%</span> <span class="n">size</span><span class="p">)</span> <span class="o">/</span> <span class="n">size</span>
                <span class="k">if</span> <span class="n">subbeat</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{beat}</span><span class="s2">.</span><span class="si">{subbeat}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">beat</span><span class="p">)</span>

            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;beats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[[</span><span class="s1">&#39;offset&#39;</span><span class="p">]]</span>\
                              <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;onset&#39;</span><span class="p">,</span> <span class="s1">&#39;timesig&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>\
                              <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">compute_beat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;pcs&#39;</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pcs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">midi</span> <span class="o">%</span> <span class="mi">12</span>
        <span class="k">if</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>\
                              <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ix&#39;</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>\
                              <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ix&#39;</span><span class="p">:</span> <span class="s1">&#39;n&#39;</span><span class="p">})</span>

        <span class="c1"># apply requested filters</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">selector</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">selector</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">selector</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">==</span> <span class="n">selector</span>
            <span class="k">elif</span> <span class="n">selector</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">selector</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">selector</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">selector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">selector</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">==</span> <span class="n">selector</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">==</span> <span class="n">selector</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Error while applying filter to </span><span class="si">{feature}</span><span class="s2">: df[</span><span class="si">{sel}</span><span class="s2">] caused an error.&quot;</span><span class="p">)</span>

        <span class="c1"># Postprocessing</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;No notes exist for this selection.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;n&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">multiindex</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="Score.itersections"><a class="viewcode-back" href="../ms3.html#ms3.Score.itersections">[docs]</a>    <span class="k">def</span> <span class="nf">itersections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repeats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">volta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multiindex</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate through sections&#39; note lists.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        section : :obj:`int`, optional</span>
<span class="sd">            Pass a section index if you want to iterate through all its repetitions</span>
<span class="sd">            with correct voltas being taken care of. By default, iterate through all sections.</span>
<span class="sd">        repeats : :obj:`bool`, optional</span>
<span class="sd">            Defaults to True. If you don&#39;t want to iterate through the different repeats,</span>
<span class="sd">            pass False and define the parameter `volta` (if the piece has any).</span>
<span class="sd">        volta : :obj:`int`, optional</span>
<span class="sd">            If you pass an integer, at every repeat the same volta is included.</span>
<span class="sd">            Pass -1 to always use the last volta. Defaults to automatic behaviour.</span>
<span class="sd">        multiindex : :obj:`bool`, optional</span>
<span class="sd">            Defaults to False. Pass True if you want a 2-level multiindex where the</span>
<span class="sd">            first level has the section number (1a for first repeat, 1b for second etc.)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :obj:`generator`</span>
<span class="sd">            At every iteration, a DataFrame with a list of notes is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">repeats</span><span class="p">:</span>
                <span class="n">section_order</span> <span class="o">=</span> <span class="n">disambiguate_repeats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section_order</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">section_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&#39;section&#39; needs to be an integer, not </span><span class="si">{section.__class__}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">repeats</span><span class="p">:</span>
                <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">repeated</span><span class="p">:</span>
                    <span class="n">section_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="n">voltas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">voltas</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">voltas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">section_order</span> <span class="o">=</span> <span class="n">disambiguate_repeats</span><span class="p">([</span><span class="n">section</span><span class="p">]</span> <span class="o">*</span> <span class="n">voltas</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">section_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">section</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">disambiguate_repeats</span><span class="p">(</span><span class="n">section_order</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">multiindex</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_notes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">volta</span><span class="o">=</span><span class="n">volta</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">volta</span><span class="o">=</span><span class="n">volta</span><span class="p">)</span></div></div>


<span class="c1">########################## End of class Score ##################################</span>

<span class="c1"># %% Playground</span>
<span class="c1"># S = Score(&#39;./scores/781/D781ecossaise07.mscx&#39;)</span>
<span class="c1"># S.get_notes([1,1,1])</span>
<span class="c1"># test[test.volta.notna()]</span>
<span class="c1">#for subdir, dirs, files in os.walk(&#39;scores&#39;):</span>
<span class="c1">#    for file in files:</span>
<span class="c1">#        if file.endswith(&#39;mscx&#39;):</span>
<span class="c1">#            S = Score(os.path.join(subdir,file))</span>
<span class="c1"># S.info</span>
<span class="c1"># S.sections[1].voltas</span>
<span class="c1"># S.section_structure</span>
<span class="c1"># compute_repeat_structure(S.info)</span>
<span class="c1"># S.sections[0]</span>
<span class="c1">#S.get_notes((12,6))</span>
<span class="c1"># S.get_notes(1, True, True)</span>
<span class="c1"># S.sections[1].events[S.sections[1].events.mc == 11]</span>
<span class="c1"># S.sections</span>
<span class="c1"># S.section_structure</span>
<span class="c1"># S.section_order</span>
<span class="c1"># S.super_sections</span>
<span class="c1"># S.super_section_order</span>
<span class="c1"># logging.basicConfig(level=logging.DEBUG)</span>
<span class="c1"># logging.getLogger().setLevel(logging.DEBUG)</span>
<span class="c1">#logging.getLogger().setLevel(logging.INFO)</span>
<span class="c1"># %% Exclude this from the main cell</span>

<span class="c1">################################################################################</span>
<span class="c1">#                           COMMANDLINE USAGE</span>
<span class="c1">################################################################################</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">-------------------------------------</span>
<span class="s1">| Parser for MuseScore3 MSCX files. |</span>
<span class="s1">-------------------------------------</span>

<span class="s1">At the moment, this is just a skeleton. Later, the commandline can be used to</span>
<span class="s1">quickly parse entire folders and store files with the computed data.&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;FILE&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Absolute or relative path to the MSCX file you want to parse.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span><span class="s1">&#39;--logging&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set logging to one of the levels {DEBUG, INFO, WARNING, ERROR, CRITICAL}.&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">logging_levels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;DEBUG&#39;</span><span class="p">:</span>    <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
        <span class="s1">&#39;INFO&#39;</span><span class="p">:</span>     <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="s1">&#39;WARNING&#39;</span><span class="p">:</span>  <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
        <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span>    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
        <span class="s1">&#39;CRITICAL&#39;</span><span class="p">:</span>  <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span>
        <span class="p">}</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging_levels</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">logging</span><span class="p">])</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">score</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Successfully parsed.&quot;</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, TeamSchubert

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>